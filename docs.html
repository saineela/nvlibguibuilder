<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NVLib v4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            color: #334155; /* Slate-700 */
        }
        /* Custom Scrollbar to match doc feel */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f5f9; 
        }
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        .canvas {
            background-color: #f8fafc; /* Slate-50 */
            border: 1px solid #e2e8f0; /* Slate-200 */
            position: relative;
            overflow: hidden;
            background-image:
                linear-gradient(to right, #e2e8f0 1px, transparent 1px),
                linear-gradient(to bottom, #e2e8f0 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .component {
            position: absolute;
            cursor: move;
            border: 1px solid transparent;
            user-select: none;
            font-size: 14px;
            box-sizing: border-box;
        }
        .component.selected {
            outline: 2px solid #4f46e5; /* Primary Indigo */
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.4);
        }
        .resizer {
            width: 10px;
            height: 10px;
            background: #4f46e5; /* Primary Indigo */
            border: 1px solid white;
            position: absolute;
            right: -5px;
            bottom: -5px;
            cursor: se-resize;
            z-index: 10;
        }
        .component-render-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: none;
            background-color: #fff;
            padding: 0 8px;
            overflow: hidden;
            box-sizing: border-box;
        }
        .id-error {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
        }
        .material-symbols-outlined {
          font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        .preview-component {
            position: absolute;
            box-sizing: border-box;
        }
        .preview-component input, .preview-component textarea, .preview-component select, .preview-component button {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            cursor: pointer;
        }
        .preview-button:active {
            transform: scale(0.98);
            filter: brightness(0.95);
        }
        #context-menu {
            width: 160px;
        }
        .submenu-container:hover .submenu {
            display: block;
        }
        
        /* Input styling overrides to match slate theme */
        input[type="text"], input[type="number"], select, textarea {
            border-color: #cbd5e1; /* Slate-300 */
            color: #334155;
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            ring-color: #4f46e5;
            border-color: #4f46e5;
            outline: none;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
    </style>
</head>
<body class="bg-slate-100 text-slate-700 h-screen flex flex-col overflow-hidden">

    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-white border-b border-slate-200 shadow-sm p-4 flex justify-between items-center z-20">
            <!-- Updated Title Color -->
            <h1 class="text-2xl font-bold text-indigo-600">NVLib v4</h1>
            
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <label for="window-title" class="text-sm font-semibold text-slate-600">Window Title:</label>
                    <input type="text" id="window-title" value="My GUI" class="w-48 p-2 border border-slate-300 rounded-md bg-slate-50 text-slate-800">
                </div>
                <div class="flex items-center space-x-2">
                    <label for="canvas-width" class="text-sm font-semibold text-slate-600">Width:</label>
                    <input type="number" id="canvas-width" value="800" class="w-20 p-2 border border-slate-300 rounded-md bg-slate-50 text-slate-800">
                    <label for="canvas-height" class="text-sm font-semibold text-slate-600">Height:</label>
                    <input type="number" id="canvas-height" value="600" class="w-20 p-2 border border-slate-300 rounded-md bg-slate-50 text-slate-800">
                    <button id="resize-canvas" class="px-3 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 text-sm font-medium shadow-sm transition-colors">Resize</button>
                </div>
                
                <div class="h-6 w-px bg-slate-300 mx-2"></div>

                <button id="live-preview-btn" class="px-3 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 text-sm font-medium shadow-sm transition-colors">Preview</button>
                <button id="save-json" class="px-3 py-2 bg-emerald-600 text-white rounded-md hover:bg-emerald-700 text-sm font-medium shadow-sm transition-colors">Save</button>
                <label for="load-json-input" class="px-3 py-2 bg-amber-500 text-white rounded-md hover:bg-amber-600 cursor-pointer text-sm font-medium shadow-sm transition-colors">Load</label>
                <input type="file" id="load-json-input" class="hidden" accept=".json">
                
                <a href="docs.html" target="_blank" class="px-3 py-2 bg-slate-700 text-white rounded-md hover:bg-slate-800 flex items-center text-sm font-medium shadow-sm transition-colors ml-2">
                    <span class="material-symbols-outlined text-sm mr-1">description</span> Docs
                </a>
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Left Sidebar -->
            <aside class="w-64 bg-slate-50 border-r border-slate-200 p-4 overflow-y-auto z-10">
                <h2 class="text-lg font-bold text-slate-800 mb-4">Components</h2>
                <div class="space-y-4">
                    <div>
                        <label for="component-select" class="block text-sm font-medium text-slate-600 mb-1">Select Type</label>
                        <select id="component-select" class="block w-full pl-3 pr-10 py-2 text-base border-slate-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md bg-white">
                            <option>Button</option>
                            <option>Label</option>
                            <option>TextBox</option>
                            <option>TextArea</option>
                            <option>Checkbox</option>
                            <option>RadioGroup</option>
                            <option>Dropdown</option>
                            <option>Slider</option>
                            <option>Panel</option>
                            <option>ProgressBar</option>
                            <option>Spinner</option>
                            <option>CardView</option>
                            <option>ToggleButton</option>
                            <option>Image</option>
                        </select>
                    </div>
                    <button id="add-component" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 font-medium shadow-sm transition-colors">Add Component</button>
                </div>
                <div class="mt-8 p-4 bg-white border border-slate-200 rounded-lg shadow-sm">
                    <h3 class="font-semibold text-slate-800 text-sm uppercase tracking-wide mb-2">Quick Guide</h3>
                    <p class="text-sm text-slate-600 space-y-1 leading-relaxed">
                        1. Select & Add.<br>
                        2. Drag & Resize.<br>
                        3. Edit Properties on right.<br>
                        4. Save JSON.<br>
                        5. Check <a href="docs.html" target="_blank" class="text-indigo-600 hover:underline font-medium">docs.html</a>.<br>
                    </p>
                </div>
            </aside>

            <!-- Canvas Area -->
            <main class="flex-1 p-6 bg-slate-200 flex justify-center overflow-y-auto">
                <div id="canvas" class="canvas shadow-xl rounded-sm" style="width: 800px; height: 600px; background-color: white;"></div>
            </main>

            <!-- Right Sidebar (Property Editor) -->
            <aside id="property-editor" class="w-80 bg-slate-50 border-l border-slate-200 p-4 overflow-y-auto z-10 hidden">
                <h2 class="text-lg font-bold text-slate-800 mb-4">Properties</h2>
                <div id="properties-form" class="space-y-4"></div>
                <div class="pt-6 mt-4 border-t border-slate-200">
                     <button id="delete-component" class="w-full px-4 py-2 bg-rose-600 text-white rounded-md hover:bg-rose-700 font-medium shadow-sm transition-colors">Delete Component</button>
                </div>
            </aside>
        </div>
    </div>
    
    <!-- Custom Context Menu -->
    <div id="context-menu" class="hidden absolute bg-white shadow-xl border border-slate-200 rounded-md py-1 z-50">
        <a href="#" data-action="duplicate" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">Duplicate</a>
        <div class="border-t border-slate-100 my-1"></div>
        <div class="submenu-container relative">
            <a href="#" class="flex justify-between items-center w-full px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">
                <span>Layout</span>
                <span class="text-xs">&gt;</span>
            </a>
            <div class="submenu hidden absolute left-full top-0 mt-[-5px] bg-white shadow-xl border border-slate-200 rounded-md py-1 w-40">
                <a href="#" data-action="bring-forward" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">Bring Forward</a>
                <a href="#" data-action="send-backward" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">Send Backward</a>
                <div class="border-t border-slate-100 my-1"></div>
                <a href="#" data-action="bring-to-front" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">Bring to Front</a>
                <a href="#" data-action="send-to-back" class="block px-4 py-2 text-sm text-slate-700 hover:bg-slate-50">Send to Back</a>
            </div>
        </div>
    </div>

    <!-- Live Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-900 bg-opacity-50 backdrop-blur-sm">
        <div id="preview-content" class="bg-white rounded-lg shadow-2xl flex flex-col w-full h-full max-w-4xl max-h-[85%] border border-slate-200">
            <div class="p-3 border-b border-slate-200 flex justify-between items-center bg-slate-50 rounded-t-lg">
                <h3 class="text-lg font-semibold text-slate-800">Live Preview</h3>
                <div>
                    <button id="fullscreen-preview-btn" class="px-3 py-1 bg-white border border-slate-300 text-slate-700 rounded-md hover:bg-slate-50 text-sm font-medium">Full Screen</button>
                    <button id="close-preview-btn" class="ml-2 px-3 py-1 bg-rose-500 text-white rounded-md hover:bg-rose-600 text-sm font-medium">&times; Close</button>
                </div>
            </div>
            <div class="p-6 flex-1 bg-slate-100 overflow-auto flex justify-center">
                <div id="preview-canvas" class="bg-white relative shadow-md ring-1 ring-slate-900/5"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('canvas');
            const addComponentBtn = document.getElementById('add-component');
            const componentSelect = document.getElementById('component-select');
            const propertyEditor = document.getElementById('property-editor');
            const propertiesForm = document.getElementById('properties-form');
            const saveJsonBtn = document.getElementById('save-json');
            const loadJsonInput = document.getElementById('load-json-input');
            const resizeCanvasBtn = document.getElementById('resize-canvas');
            const canvasWidthInput = document.getElementById('canvas-width');
            const canvasHeightInput = document.getElementById('canvas-height');
            const deleteComponentBtn = document.getElementById('delete-component');
            const livePreviewBtn = document.getElementById('live-preview-btn');
            const previewModal = document.getElementById('preview-modal');
            const previewCanvas = document.getElementById('preview-canvas');
            const previewContent = document.getElementById('preview-content');
            const closePreviewBtn = document.getElementById('close-preview-btn');
            const fullscreenPreviewBtn = document.getElementById('fullscreen-preview-btn');
            const contextMenu = document.getElementById('context-menu');
            const windowTitleInput = document.getElementById('window-title');

            let components = [];
            let selectedComponent = null;
            let componentIdCounter = 0;
            let contextComponentId = null;

            const getComponentDefaults = (type) => {
    const base = {
        textColor: '#334155', // Slate-700 default text
        fontSize: 14,
        bold: false,
    };
    const textBase = { ...base, text: type };
    const placeholderImg = 'data:image/svg+xml;base64,...';

    switch (type) {
        case 'Button': return { ...textBase, backgroundColor: '#ffffff', cornerRadius: 4 };
        case 'Label': return { ...textBase, iconName: '' };
        case 'TextBox': return { text: '', hintText: 'Enter text...', hintColor: '#94a3b8', backgroundColor: '#ffffff', ...base };
        case 'TextArea': return { text: '', hintText: 'Enter text...', hintColor: '#94a3b8', backgroundColor: '#ffffff', ...base };
        case 'Checkbox': return { text: 'Checkbox', checked: false, checkedColor: '#4f46e5', ...base };
        case 'RadioGroup': return { label: 'Select an Option', options: 'Option 1\nOption 2', checkedValue: 'Option 1', checkedColor: '#4f46e5', ...base };
        case 'Dropdown': return { text: 'Dropdown', options: 'Option 1\nOption 2', backgroundColor: '#ffffff', selectionColor: '#e0e7ff', ...base };
        case 'Slider': return { min: 0, max: 100, value: 50, progressColor: '#4f46e5', buttonColor: '#4f46e5' };
        case 'Panel': return { backgroundColor: '#f1f5f9', cornerRadius: 0 };
        case 'ProgressBar': return { value: 50, progressColor: '#4f46e5', textColor: '#334155', textPosition: 'right' };
        case 'Spinner': return { min: 0, max: 100, value: 25, backgroundColor: '#ffffff', ...base };
        case 'CardView': return { ...textBase, backgroundColor: '#ffffff', cornerRadius: 8, elevation: 2 };
        case 'ToggleButton': return { checked: false, onColor: '#10b981', offColor: '#cbd5e1' };
        case 'Image': return { src: placeholderImg, cornerRadius: 0, opacity: 1, fit: 'cover', backgroundColor: '#ffffff' };
        default: return textBase;
    }
};


            resizeCanvasBtn.addEventListener('click', () => {
                canvas.style.width = `${canvasWidthInput.value}px`;
                canvas.style.height = `${canvasHeightInput.value}px`;
            });

            addComponentBtn.addEventListener('click', () => {
                const componentType = componentSelect.value;
                let id = `${componentType.toLowerCase()}_${componentIdCounter++}`;
                while (components.some(c => c.id === id)) {
                    id = `${componentType.toLowerCase()}_${componentIdCounter++}`;
                }
                
                const componentData = {
                    id: id, type: componentType, x: 50, y: 50,
                    width: 150, height: 40,
                    zIndex: components.length,
                    properties: getComponentDefaults(componentType)
                };
                
                if(componentType === 'Image' || componentType === 'RadioGroup') componentData.height = 100;
                if(componentType === 'Slider') componentData.width = 200;
                if(componentType === 'TextArea') componentData.height = 80;
                if(componentType === 'Panel' || componentType === 'CardView') { componentData.width = 200; componentData.height = 150; }
                if(componentType === 'ProgressBar' || componentType === 'Slider') componentData.height = 25;
                if(componentType === 'ToggleButton') { componentData.width = 60; componentData.height = 32; }
                if(componentType === 'Label') { componentData.width = 40; componentData.height = 40; }

                components.push(componentData);
                renderAllComponents();
                selectComponent(id);
            });
            
            function reorderZIndexes() {
                components.sort((a, b) => a.zIndex - b.zIndex);
                components.forEach((c, index) => c.zIndex = index);
                renderAllComponents();
            }

            function renderAllComponents() {
                components.sort((a, b) => a.zIndex - b.zIndex);
                canvas.innerHTML = '';
                components.forEach(comp => renderComponent(comp, true));
            }

            function renderComponent(comp, isBatchRender = false) {
                let el = document.getElementById(comp.id);
                if (!el) {
                    el = document.createElement('div');
                    el.id = comp.id;
                    el.className = 'component';
                    canvas.appendChild(el);
                    
                    const resizer = document.createElement('div');
                    resizer.className = 'resizer';
                    el.appendChild(resizer);
                    
                    makeDraggable(el);
                    makeResizable(el, resizer);

                    el.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectComponent(comp.id);
                    });

                    el.addEventListener('contextmenu', e => {
                        e.preventDefault();
                        e.stopPropagation();
                        contextComponentId = comp.id;
                        contextMenu.style.top = `${e.clientY}px`;
                        contextMenu.style.left = `${e.clientX}px`;
                        contextMenu.classList.remove('hidden');
                        selectComponent(comp.id);
                    });
                }

                el.style.left = `${comp.x}px`;
                el.style.top = `${comp.y}px`;
                el.style.width = `${comp.width}px`;
                el.style.height = `${comp.height}px`;
                el.style.zIndex = comp.zIndex;

                el.innerHTML = getComponentHTML(comp) + (el.querySelector('.resizer')?.outerHTML || '<div class="resizer"></div>');
                makeResizable(el, el.querySelector('.resizer'));

                if (selectedComponent && selectedComponent.id === comp.id) {
                    el.classList.add('selected');
                }
            }

            function getComponentHTML(comp) {
                const p = comp.properties;
                const baseStyles = `color:${p.textColor}; font-size:${p.fontSize}px; font-weight:${p.bold ? 'bold' : 'normal'};`;
                let wrapperStyles = `background-color:${p.backgroundColor || 'white'}; border-radius:${p.cornerRadius || 0}px;`;
                
                switch(comp.type) {
                    case 'Image':
                        return `<div class="component-render-wrapper" style="padding:0; border:none; background:transparent;">
                                    <img src="${p.src}" style="width:100%; height:100%; object-fit:${p.fit}; border-radius:${p.cornerRadius}px; opacity:${p.opacity};" />
                                </div>`;
                    case 'Button':
                    case 'CardView':
                         if(comp.type === 'CardView') wrapperStyles += ` box-shadow: 0 ${p.elevation*2}px ${p.elevation*3}px rgba(0,0,0,0.1);`;
                         return `<div class="component-render-wrapper" style="${wrapperStyles}"><span style="${baseStyles}">${p.text}</span></div>`;
                    case 'Panel':
                         return `<div class="component-render-wrapper" style="${wrapperStyles}"></div>`;
                    case 'Label':
                        if (p.iconName && p.iconName.trim() !== '') {
                            const iconStyles = `font-family: 'Material Symbols Outlined'; font-size: ${p.fontSize}px; color:${p.textColor};`;
                            return `<div class="component-render-wrapper" style="border:none; background:transparent;"><span class="material-symbols-outlined" style="${iconStyles}">${p.iconName}</span></div>`;
                        }
                        return `<div class="component-render-wrapper" style="border:none; background:transparent;"><span style="${baseStyles}">${p.text}</span></div>`;
                    case 'TextBox':
                    case 'TextArea':
                        const hint = `<span style='color:${p.hintColor};'>${p.hintText}</span>`;
                        const align = comp.type === 'TextArea' ? 'align-self: flex-start;' : '';
                        return `<div class="component-render-wrapper" style="${wrapperStyles}">
                                    <span style="${baseStyles} width: 100%; text-align: left; ${align}">${p.text || hint}</span>
                                </div>`;
                    case 'Checkbox':
                        return `<div class="component-render-wrapper" style="border:none; background:transparent; justify-content:flex-start;">
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <div style="width:16px; height:16px; border:1px solid #94a3b8; display:flex; align-items:center; justify-content:center; background:${p.checked ? p.checkedColor : 'white'}; border-radius: 2px">
                                            ${p.checked ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"></path></svg>' : ''}
                                        </div>
                                        <span style="${baseStyles}">${p.text}</span>
                                    </div>
                                </div>`;
                    case 'RadioGroup':
                        let radioHTML = `<div style="${baseStyles} margin-bottom: 8px;">${p.label}</div>`;
                        const options = p.options.split('\n');
                        options.forEach(opt => {
                            const isChecked = opt === p.checkedValue;
                            radioHTML += `<div style="display:flex; align-items:center; gap:8px; margin-bottom: 4px;">
                                            <div style="width:16px; height:16px; border:1px solid #94a3b8; display:flex; align-items:center; justify-content:center; background:${isChecked ? p.checkedColor : 'white'}; border-radius:50%">
                                                ${isChecked ? `<div style="width:8px; height:8px; background:white; border-radius:50%;"></div>` : ''}
                                            </div>
                                            <span style="${baseStyles}">${opt}</span>
                                        </div>`;
                        });
                        return `<div class="component-render-wrapper" style="border:none; background:transparent; flex-direction: column; align-items: flex-start;">${radioHTML}</div>`;
                    case 'ProgressBar':
                        return `<div style="width:100%; height:100%; border-radius: 999px; position:relative; display:flex; align-items:center; overflow:hidden;">
                                    <div style="width:${p.value}%; height:100%; background-color:${p.progressColor}; border-radius: 999px;"></div>
                                </div>`;
                    case 'Slider':
                        const sliderPercent = (p.value - p.min) / (p.max - p.min) * 100;
                        return `<div class="component-render-wrapper" style="border:none; background:transparent;">
                                    <div style="width:100%; height:6px; background:#e2e8f0; border-radius:3px; position:relative;">
                                        <div style="position:absolute; left:0; top:0; height:100%; width:${sliderPercent}%; background:${p.progressColor}; border-radius:3px;"></div>
                                        <div style="position:absolute; left:${sliderPercent}%; transform:translateX(-50%); top:-6px; width:18px; height:18px; background:${p.buttonColor}; border-radius:50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                    </div>
                                </div>`;
                    case 'ToggleButton':
                        return `<div class="component-render-wrapper" style="border:none; background:transparent;">
                                    <div style="width:100%; height:100%; background-color:${p.checked ? p.onColor : p.offColor}; border-radius:999px; position:relative; transition: background-color 0.2s ease;">
                                        <div style="position:absolute; top:4px; left:4px; width:24px; height:24px; background:white; border-radius:50%; box-shadow:0 1px 3px rgba(0,0,0,0.2); transition: transform 0.2s ease; transform: ${p.checked ? 'translateX(28px)' : 'translateX(0)'};"></div>
                                    </div>
                                </div>`;
                    case 'Spinner':
                        return `<div class="component-render-wrapper" style="background-color:${p.backgroundColor}; justify-content:space-between; padding:0;">
                                    <button class="h-full px-2" style="font-size:${p.fontSize}px; color:${p.textColor};">-</button>
                                    <span style="${baseStyles}">${p.value}</span>
                                    <button class="h-full px-2" style="font-size:${p.fontSize}px; color:${p.textColor};">+</button>
                                </div>`;
                    default:
                        return `<div class="component-render-wrapper" style="${wrapperStyles}"><span style="${baseStyles}">${p.text}</span></div>`;
                }
            }
            
            deleteComponentBtn.addEventListener('click', () => {
                if (!selectedComponent) return;
                document.getElementById(selectedComponent.id)?.remove();
                components = components.filter(c => c.id !== selectedComponent.id);
                selectedComponent = null;
                propertyEditor.classList.add('hidden');
            });

            function selectComponent(id) {
                selectedComponent = components.find(c => c.id === id) || null;
                document.querySelectorAll('.component').forEach(el => el.classList.remove('selected'));
                if (selectedComponent) {
                    document.getElementById(id)?.classList.add('selected');
                    propertyEditor.classList.remove('hidden');
                    populatePropertyEditor(selectedComponent);
                } else {
                    propertyEditor.classList.add('hidden');
                }
            }

            canvas.addEventListener('click', () => selectComponent(null));
            document.addEventListener('click', () => contextMenu.classList.add('hidden'));

            function populatePropertyEditor(component) {
                propertiesForm.innerHTML = '';
                const addField = (parent, type, label, value, key, options = {}) => {
                    const div = document.createElement('div');
                    const labelEl = document.createElement('label');
                    labelEl.className = 'block text-sm font-medium text-slate-700';
                    labelEl.textContent = label;
                    
                    let input;
                    if (type === 'file-button') {
                        labelEl.htmlFor = `file-input-${component.id}`;
                        labelEl.className += ' w-full text-center px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 cursor-pointer shadow-sm transition-colors';
                        input = document.createElement('input');
                        input.type = 'file';
                        input.id = `file-input-${component.id}`;
                        input.className = 'hidden';
                        input.accept = 'image/*';
                        input.addEventListener('change', (e) => {
                            const file = e.target.files[0];
                            if (!file) return;
                            const reader = new FileReader();
                            reader.onload = (readEvent) => {
                                updateComponentProperty(component.id, 'src', readEvent.target.result);
                            };
                            reader.readAsDataURL(file);
                        });
                        div.appendChild(labelEl);
                        div.appendChild(input);
                    } else {
                        div.appendChild(labelEl);
                        if (type === 'textarea') {
                            input = document.createElement('textarea');
                            input.rows = 3;
                        } else if (type === 'select') {
                            input = document.createElement('select');
                            options.choices.forEach(c => {
                                const opt = document.createElement('option');
                                opt.value = c;
                                opt.textContent = c.charAt(0).toUpperCase() + c.slice(1);
                                input.appendChild(opt);
                            });
                        } else {
                            input = document.createElement('input');
                            input.type = type;
                            if (options.step) input.step = options.step;
                            if (options.min) input.min = options.min;
                            if (options.max) input.max = options.max;
                        }

                        input.value = value ?? '';
                        input.dataset.key = key;
                        input.className = 'mt-1 block w-full p-2 border border-slate-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white text-slate-800';
                        if (type === 'color') input.className += ' h-10 p-1';
                        if (type === 'checkbox') {
                            input.checked = !!value;
                            input.className = 'h-4 w-4 text-indigo-600 border-slate-300 rounded focus:ring-indigo-500';
                            div.className = 'flex items-center gap-x-2';
                            div.insertBefore(input, labelEl);
                        }

                        input.addEventListener(type === 'checkbox' ? 'change' : 'input', (e) => {
                            const originalId = component.id;
                            const val = type === 'checkbox' ? e.target.checked : e.target.value;
                            updateComponentProperty(originalId, key, val, e.target);
                        });
                        div.appendChild(input);
                    }
                    parent.appendChild(div);
                };

                addField(propertiesForm, 'text', 'ID', component.id, 'id');

                const p = component.properties;
                if (component.type === 'Image') {
                    addField(propertiesForm, 'file-button', 'Upload Image', null, 'src');
                    addField(propertiesForm, 'number', 'Corner Radius (px)', p.cornerRadius, 'cornerRadius', {min: 0});
                    addField(propertiesForm, 'range', `Opacity (${p.opacity})`, p.opacity, 'opacity', {min: 0, max: 1, step: 0.1});
                    addField(propertiesForm, 'select', 'Image Fit', p.fit, 'fit', { choices: ['fill', 'contain', 'cover', 'none'] });
                } else {
                    for (const key in p) {
                        // Hide unsupported properties globally (no fontFamily, borders, trackColor)
                        if (key === 'fontFamily' || key === 'trackColor' || key === 'borderColor' || key === 'borderWidth') continue;

                        const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                        let type = 'text';
                        if (key.includes('Color')) type = 'color';
                        else if (typeof p[key] === 'number') type = 'number';
                        else if (typeof p[key] === 'boolean') type = 'checkbox';
                        else if (key === 'options') type = 'textarea';

                        addField(propertiesForm, type, label, p[key], key);
                    }
                }
            }

            function updateComponentProperty(id, key, value, targetElement) {
                const component = components.find(c => c.id === id);
                if (!component) return;
                
                if (key === 'id') {
                    const isDuplicate = components.some(c => c.id === value && c.id !== id);
                    if (isDuplicate || value.trim() === '') {
                        if(targetElement) targetElement.classList.add('id-error');
                        return;
                    }
                    if(targetElement) targetElement.classList.remove('id-error');
                    
                    document.getElementById(id).id = value;
                    component.id = value;
                    if(selectedComponent && selectedComponent.id === id) selectedComponent.id = value;
                    return;
                }

                if (typeof component.properties[key] === 'number') {
                    value = parseFloat(value) || 0;
                }
                component.properties[key] = value;
                renderComponent(component);
                
                if ((component.type === 'Label' && key === 'iconName') && selectedComponent && selectedComponent.id === id) {
                    populatePropertyEditor(component);
                }

                if (targetElement && targetElement.type === 'range') {
                    const label = targetElement.closest('div').querySelector('label');
                    if (label) {
                        label.textContent = `${label.textContent.split('(')[0].trim()} (${value})`;
                    }
                }
            }

            function makeDraggable(element) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                element.onmousedown = e => {
                    if (e.target.classList.contains('resizer')) return;
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = () => {
                        document.onmouseup = null;
                        document.onmousemove = null;
                        const component = components.find(c => c.id === element.id);
                        if (component) {
                            component.x = element.offsetLeft;
                            component.y = element.offsetTop;
                        }
                    };
                    document.onmousemove = me => {
                        me.preventDefault();
                        pos1 = pos3 - me.clientX;
                        pos2 = pos4 - me.clientY;
                        pos3 = me.clientX;
                        pos4 = me.clientY;
                        
                        let newTop = element.offsetTop - pos2;
                        let newLeft = element.offsetLeft - pos1;

                        if (newLeft < 0) newLeft = 0;
                        if (newTop < 0) newTop = 0;
                        if (newLeft + element.offsetWidth > canvas.offsetWidth) newLeft = canvas.offsetWidth - element.offsetWidth;
                        if (newTop + element.offsetHeight > canvas.offsetHeight) newTop = canvas.offsetHeight - element.offsetHeight;

                        element.style.top = `${newTop}px`;
                        element.style.left = `${newLeft}px`;
                    };
                };
            }

            function makeResizable(element, resizer) {
                if (!resizer) return;
                resizer.addEventListener('mousedown', e => {
                    e.stopPropagation();
                    window.addEventListener('mousemove', resize);
                    window.addEventListener('mouseup', stopResize);
                });

                function resize(e) {
                    let newWidth = (e.clientX - element.getBoundingClientRect().left);
                    let newHeight = (e.clientY - element.getBoundingClientRect().top);
                    if (newWidth < 20) newWidth = 20;
                    if (newHeight < 20) newHeight = 20;
                    element.style.width = `${newWidth}px`;
                    element.style.height = `${newHeight}px`;
                }

                function stopResize() {
                    window.removeEventListener('mousemove', resize);
                    window.removeEventListener('mouseup', stopResize);
                    const component = components.find(c => c.id === element.id);
                    if (component) {
                        component.width = element.offsetWidth;
                        component.height = element.offsetHeight;
                    }
                }
            }

            contextMenu.addEventListener('click', e => {
                e.preventDefault();
                const action = e.target.dataset.action;
                if (!action || !contextComponentId) {
                    contextMenu.classList.add('hidden');
                    return;
                };

                const clickedComp = components.find(c => c.id === contextComponentId);
                if (!clickedComp) return;

                const sorted = [...components].sort((a,b) => a.zIndex - b.zIndex);
                const currentIndex = sorted.findIndex(c => c.id === contextComponentId);

                switch (action) {
                    case 'bring-forward':
                        if (currentIndex < sorted.length - 1) {
                           const nextComp = sorted[currentIndex + 1];
                           [clickedComp.zIndex, nextComp.zIndex] = [nextComp.zIndex, clickedComp.zIndex];
                        }
                        break;
                    case 'send-backward':
                        if (currentIndex > 0) {
                            const prevComp = sorted[currentIndex - 1];
                           [clickedComp.zIndex, prevComp.zIndex] = [prevComp.zIndex, clickedComp.zIndex];
                        }
                        break;
                    case 'bring-to-front':
                        clickedComp.zIndex = components.length;
                        break;
                    case 'send-to-back':
                         clickedComp.zIndex = -1;
                        break;
                    case 'duplicate':
                        duplicateComponent(contextComponentId);
                        break;
                }
                reorderZIndexes();
                contextMenu.classList.add('hidden');
            });
            
            function duplicateComponent(id) {
                const originalComp = components.find(c => c.id === id);
                if (!originalComp) return;

                const newComp = JSON.parse(JSON.stringify(originalComp));
                
                let copyCount = 1;
                let newId = `${originalComp.id}_copy_${copyCount}`;
                while (components.some(c => c.id === newId)) {
                    copyCount++;
                    newId = `${originalComp.id}_copy_${copyCount}`;
                }
                newComp.id = newId;
                newComp.x += 10;
                newComp.y += 10;
                newComp.zIndex = components.length;
                components.push(newComp);
                renderAllComponents();
                selectComponent(newId);
            }

            function openPreview() {
                previewCanvas.innerHTML = '';
                previewCanvas.style.width = canvas.style.width;
                previewCanvas.style.height = canvas.style.height;

                let dynamicStyles = document.getElementById('dynamic-preview-styles');
                if (dynamicStyles) dynamicStyles.remove();
                dynamicStyles = document.createElement('style');
                dynamicStyles.id = 'dynamic-preview-styles';
                document.head.appendChild(dynamicStyles);

                components.forEach(comp => {
                    const p = comp.properties;
                    const elWrapper = document.createElement('div');
                    elWrapper.className = 'preview-component';
                    elWrapper.style.left = `${comp.x}px`;
                    elWrapper.style.top = `${comp.y}px`;
                    elWrapper.style.width = `${comp.width}px`;
                    elWrapper.style.height = `${comp.height}px`;

                    let el;
                    switch(comp.type) {
                        case 'Button':
                            el = document.createElement('button');
                            el.textContent = p.text;
                            el.className = 'preview-button';
                            el.style.transition = 'transform 0.1s ease, filter 0.1s ease';
                            el.style.backgroundColor = p.backgroundColor;
                            el.style.color = p.textColor;
                            el.style.fontSize = `${p.fontSize}px`;
                            el.style.fontWeight = p.bold ? 'bold' : 'normal';
                            el.style.borderRadius = `${p.cornerRadius}px`;
                            el.style.border = '1px solid #94a3b8';
                            break;
                        case 'TextBox':
                            el = document.createElement('input');
                            el.type = 'text';
                            el.placeholder = p.hintText;
                            el.value = p.text;
                            el.style.color = p.textColor;
                            el.style.backgroundColor = p.backgroundColor;
                            el.style.fontSize = `${p.fontSize}px`;
                            el.style.fontWeight = p.bold ? 'bold' : 'normal';
                            break;
                        case 'TextArea':
                            el = document.createElement('textarea');
                            el.placeholder = p.hintText;
                            el.value = p.text;
                            el.style.color = p.textColor;
                            el.style.backgroundColor = p.backgroundColor;
                            el.style.fontSize = `${p.fontSize}px`;
                            el.style.fontWeight = p.bold ? 'bold' : 'normal';
                            break;
                        case 'Checkbox':
                            el = document.createElement('div');
                            el.className = 'flex items-center justify-start gap-2';
                            const input = document.createElement('input');
                            input.type = 'checkbox';
                            input.checked = p.checked;
                            const label = document.createElement('label');
                            label.textContent = p.text;
                            label.style.color = p.textColor;
                            label.style.fontSize = `${p.fontSize}px`;
                            label.style.fontWeight = p.bold ? 'bold' : 'normal';
                            el.append(input, label);
                            break;
                        case 'RadioGroup':
                            el = document.createElement('div');
                            el.className = 'flex flex-col items-start justify-center gap-2';
                            const groupLabel = document.createElement('label');
                            groupLabel.textContent = p.label;
                            groupLabel.style.color = p.textColor;
                            groupLabel.style.fontSize = `${p.fontSize}px`;
                            groupLabel.style.fontWeight = p.bold ? 'bold' : 'normal';
                            groupLabel.style.marginBottom = '4px';
                            el.appendChild(groupLabel);
                            p.options.split('\n').forEach(opt => {
                                const optionWrapper = document.createElement('div');
                                optionWrapper.className = 'flex items-center gap-2';
                                const radioInput = document.createElement('input');
                                radioInput.type = 'radio';
                                radioInput.name = comp.id;
                                radioInput.value = opt;
                                radioInput.checked = opt === p.checkedValue;
                                const optionLabel = document.createElement('label');
                                optionLabel.textContent = opt;
                                optionLabel.style.color = p.textColor;
                                optionLabel.style.fontSize = `${p.fontSize}px`;
                                optionLabel.style.fontWeight = p.bold ? 'bold' : 'normal';
                                optionLabel.style.whiteSpace = 'nowrap';
                                optionWrapper.append(radioInput, optionLabel);
                                el.appendChild(optionWrapper);
                            });
                            break;
                        case 'Slider':
                            el = document.createElement('input');
                            el.type = 'range';
                            el.min = p.min;
                            el.max = p.max;
                            el.value = p.value;
                            el.className = `preview-slider-${comp.id}`;
                            el.style.height = '6px';
                            el.style.margin = 'auto 0';

                            const updateSliderStyle = (target) => {
                                const newPercent = ((target.value - p.min) / (p.max - p.min)) * 100;
                                target.style.background = `linear-gradient(to right, ${p.progressColor} 0%, ${p.progressColor} ${newPercent}%, #e2e8f0 ${newPercent}%, #e2e8f0 100%)`;
                            };
                            
                            dynamicStyles.innerHTML += `
                                .preview-slider-${comp.id} { -webkit-appearance: none; appearance: none; width: 100%; border-radius: 3px; outline: none; }
                                .preview-slider-${comp.id}::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: ${p.buttonColor}; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
                                .preview-slider-${comp.id}::-moz-range-thumb { width: 18px; height: 18px; background: ${p.buttonColor}; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
                            `;
                            
                            el.addEventListener('input', (e) => updateSliderStyle(e.target));
                            setTimeout(() => updateSliderStyle(el), 0);
                            break;
                        case 'Dropdown':
                            el = document.createElement('select');
                            el.className = `preview-dropdown-${comp.id}`;
                            dynamicStyles.innerHTML += `
                                .preview-dropdown-${comp.id} option:hover { background-color: ${p.selectionColor} !important; }
                            `;
                            const options = p.options.split('\n');
                            options.forEach(opt => {
                                const optionEl = document.createElement('option');
                                optionEl.value = opt;
                                optionEl.textContent = opt;
                                el.appendChild(optionEl);
                            });
                            el.style.backgroundColor = p.backgroundColor;
                            el.style.color = p.textColor;
                            el.style.fontSize = `${p.fontSize}px`;
                            el.style.fontWeight = p.bold ? 'bold' : 'normal';
                            break;
                        case 'ToggleButton':
                            el = document.createElement('label');
                            el.className = 'relative inline-flex items-center cursor-pointer';
                            const toggleInput = document.createElement('input');
                            toggleInput.type = 'checkbox';
                            toggleInput.className = 'sr-only peer';
                            toggleInput.checked = p.checked;
                            const toggleDiv = document.createElement('div');
                            toggleDiv.className = "w-11 h-6 bg-slate-300 rounded-full peer peer-focus:ring-4 peer-focus:ring-indigo-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-slate-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all";
                            toggleDiv.style.backgroundColor = p.checked ? p.onColor : p.offColor;
                            toggleInput.addEventListener('change', (e) => {
                                toggleDiv.style.backgroundColor = e.target.checked ? p.onColor : p.offColor;
                            });
                            el.append(toggleInput, toggleDiv);
                            break;
                        case 'Spinner':
                            el = document.createElement('div');
                            el.className = 'flex items-center justify-between border border-slate-400 rounded';
                            el.style.backgroundColor = p.backgroundColor || 'white';
                            const minusBtn = document.createElement('button');
                            minusBtn.textContent = '-';
                            minusBtn.className = 'px-2';
                            minusBtn.style.fontSize = `${p.fontSize}px`;
                            minusBtn.style.color = p.textColor;
                            minusBtn.style.fontWeight = p.bold ? 'bold' : 'normal';
                            const valueSpan = document.createElement('span');
                            valueSpan.textContent = p.value;
                            valueSpan.style.color = p.textColor;
                            valueSpan.style.fontSize = `${p.fontSize}px`;
                            valueSpan.style.fontWeight = p.bold ? 'bold' : 'normal';
                            const plusBtn = document.createElement('button');
                            plusBtn.textContent = '+';
                            plusBtn.className = 'px-2';
                            plusBtn.style.fontSize = `${p.fontSize}px`;
                            plusBtn.style.color = p.textColor;
                            plusBtn.style.fontWeight = p.bold ? 'bold' : 'normal';
                            
                            minusBtn.addEventListener('click', () => {
                                let val = parseInt(valueSpan.textContent);
                                if (val > p.min) valueSpan.textContent = val - 1;
                            });
                            plusBtn.addEventListener('click', () => {
                                let val = parseInt(valueSpan.textContent);
                                if (val < p.max) valueSpan.textContent = val + 1;
                            });
                            el.append(minusBtn, valueSpan, plusBtn);
                            break;
                        default:
                            el = document.createElement('div');
                            el.innerHTML = getComponentHTML(comp);
                            const innerEl = el.firstElementChild;
                            innerEl.style.width = '100%';
                            innerEl.style.height = '100%';
                            el = innerEl;
                    }
                    
                    if (el) {
                        elWrapper.appendChild(el);
                        previewCanvas.appendChild(elWrapper);
                    }
                });

                previewModal.style.display = 'flex';
            }

            function closePreview() {
                previewModal.style.display = 'none';
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
            }

            function toggleFullScreen() {
                if (!document.fullscreenElement) {
                    previewContent.requestFullscreen().catch(err => {
                        alert(`Error: ${err.message}`);
                    });
                    fullscreenPreviewBtn.textContent = 'Exit Full Screen';
                } else {
                    document.exitFullscreen();
                    fullscreenPreviewBtn.textContent = 'Full Screen';
                }
            }
            
            livePreviewBtn.addEventListener('click', openPreview);
            closePreviewBtn.addEventListener('click', closePreview);
            fullscreenPreviewBtn.addEventListener('click', toggleFullScreen);
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    fullscreenPreviewBtn.textContent = 'Full Screen';
                }
            });

            saveJsonBtn.addEventListener('click', () => {
                const sortedComponents = [...components].sort((a,b) => a.zIndex - b.zIndex);
                const layout = {
                    canvas: { 
                        width: canvas.offsetWidth, 
                        height: canvas.offsetHeight,
                        title: windowTitleInput.value
                    },
                    components: sortedComponents
                };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(layout, null, 2));
                const a = document.createElement('a');
                a.href = dataStr;
                a.download = "layout.json";
                a.click();
            });

            loadJsonInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const layout = JSON.parse(e.target.result);
                        loadLayout(layout);
                    } catch (error) {
                        alert("Invalid JSON file.");
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            });

            function loadLayout(layout) {
                canvas.style.width = `${layout.canvas.width}px`;
                canvas.style.height = `${layout.canvas.height}px`;
                canvasWidthInput.value = layout.canvas.width;
                canvasHeightInput.value = layout.canvas.height;
                windowTitleInput.value = layout.canvas.title || 'My GUI';
                
                canvas.innerHTML = '';
                components = layout.components;

                const idSet = new Set();
                const duplicateIds = new Set();
                components.forEach((c, index) => {
                    if (c.zIndex === undefined) c.zIndex = index;
                    if (idSet.has(c.id)) duplicateIds.add(c.id);
                    idSet.add(c.id);
                });

                if (duplicateIds.size > 0) {
                    alert(`Warning: Duplicate IDs found: ${Array.from(duplicateIds).join(', ')}.`);
                }
                
                componentIdCounter = components.length
                    ? Math.max(0, ...components.map(c => parseInt(c.id.split('_').pop()) || 0).filter(Number.isFinite)) + 1
                    : 0;
                
                renderAllComponents();
                selectComponent(null);
            }
        });
    </script>

</body>
</html>
