<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NVLib GUI Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .canvas {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            position: relative;
            overflow: hidden;
            background-image:
                linear-gradient(to right, #e5e7eb 1px, transparent 1px),
                linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .component {
            position: absolute;
            cursor: move;
            border: 1px solid transparent;
            user-select: none;
            font-size: 14px;
            box-sizing: border-box;
        }
        .component.selected {
            outline: 2px solid #2563eb;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
        }
        .resizer {
            width: 10px;
            height: 10px;
            background: #2563eb;
            border: 1px solid white;
            position: absolute;
            right: -5px;
            bottom: -5px;
            cursor: se-resize;
            z-index: 10;
        }
        .component-render-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #9ca3af;
            background-color: #fff;
            padding: 0 8px;
            overflow: hidden;
            box-sizing: border-box;
        }
        .id-error {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
        }
        #font-picker-modal, #preview-modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .material-symbols-outlined {
          font-variation-settings:
          'FILL' 0,
          'wght' 400,
          'GRAD' 0,
          'opsz' 24
        }
        .preview-component {
            position: absolute;
            box-sizing: border-box;
        }
        .preview-component input, .preview-component textarea, .preview-component select, .preview-component button {
            width: 100%;
            height: 100%;
            box-sizing: border-box;
            cursor: pointer;
        }
        .preview-button:active {
            transform: scale(0.98);
            filter: brightness(0.95);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-white shadow-md p-4 flex justify-between items-center z-20">
            <h1 class="text-2xl font-bold text-gray-800">NVLib GUI Builder</h1>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <label for="canvas-width" class="text-sm font-medium">Canvas Width:</label>
                    <input type="number" id="canvas-width" value="800" class="w-24 p-2 border border-gray-300 rounded-md">
                    <label for="canvas-height" class="text-sm font-medium">Height:</label>
                    <input type="number" id="canvas-height" value="600" class="w-24 p-2 border border-gray-300 rounded-md">
                    <button id="resize-canvas" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">Resize Canvas</button>
                </div>
                 <button id="live-preview-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700">Live Preview</button>
                <button id="save-json" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Save to JSON</button>
                <label for="load-json-input" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 cursor-pointer">Load from JSON</label>
                <input type="file" id="load-json-input" class="hidden" accept=".json">
            </div>
        </header>

        <!-- Main Content -->
        <div class="flex flex-1 overflow-hidden">
            <!-- Left Sidebar -->
            <aside class="w-64 bg-white p-4 overflow-y-auto shadow-lg z-10">
                <h2 class="text-lg font-semibold mb-4">Components</h2>
                <div class="space-y-4">
                    <div>
                        <label for="component-select" class="block text-sm font-medium text-gray-700">Select a component</label>
                        <select id="component-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option>Button</option>
                            <option>Label</option>
                            <option>TextBox</option>
                            <option>TextArea</option>
                            <option>Checkbox</option>
                            <option>RadioGroup</option>
                            <option>Dropdown</option>
                            <option>Slider</option>
                            <option>Panel</option>
                            <option>ProgressBar</option>
                            <option>Spinner</option>
                            <option>CardView</option>
                            <option>ToggleButton</option>
                            <option>Image</option>
                        </select>
                    </div>
                    <button id="add-component" class="w-full px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Add Component</button>
                </div>
                <div class="mt-6 p-4 bg-gray-50 rounded-lg">
                    <h3 class="font-semibold text-gray-800">Instructions</h3>
                    <p class="text-sm text-gray-600 mt-2">
                        1. Select a component and click "Add Component".<br>
                        2. Drag components to position them.<br>
                        3. Click a component to edit its specific properties.<br>
                        4. Use the handle to resize components.<br>
                        5. Save your layout to a JSON file.<br>
                        6. Create you project in VSCode.<br>
                        7. Read the Readme file in github.com/saineela/NVLib and integrate it with you code.<br>
                        8. BOOM!! You're Done!.<br>
                    </p>
                </div>
            </aside>

            <!-- Canvas -->
            <main class="flex-1 p-4 bg-gray-200 flex justify-center overflow-y-auto">
                <div id="canvas" class="canvas shadow-lg" style="width: 800px; height: 600px;"></div>
            </main>

            <!-- Right Sidebar (Property Editor) -->
            <aside id="property-editor" class="w-80 bg-white p-4 overflow-y-auto shadow-lg z-10 hidden">
                <h2 class="text-lg font-semibold mb-4">Properties</h2>
                <div id="properties-form" class="space-y-4"></div>
                <button id="delete-component" class="w-full mt-6 px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Delete Component</button>
            </aside>
        </div>
    </div>

    <!-- Font Picker Modal -->
    <div id="font-picker-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
            <div class="p-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-semibold">Select a Font</h3>
                <button id="close-font-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
            </div>
            <div id="font-list" class="p-4 h-96 overflow-y-auto"></div>
        </div>
    </div>

    <!-- Live Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 z-50 hidden items-center justify-center">
        <div id="preview-content" class="bg-white rounded-lg shadow-xl flex flex-col w-full h-full max-w-4xl max-h-[80%]">
            <div class="p-2 border-b flex justify-between items-center bg-gray-50 rounded-t-lg">
                <h3 class="text-lg font-semibold text-gray-700">Live Preview</h3>
                <div>
                    <button id="fullscreen-preview-btn" class="px-3 py-1 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm">Full Screen</button>
                    <button id="close-preview-btn" class="ml-2 px-3 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-sm">&times; Close</button>
                </div>
            </div>
            <div class="p-4 flex-1 bg-gray-100 overflow-auto">
                <div id="preview-canvas" class="bg-white relative shadow-inner"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('canvas');
            const addComponentBtn = document.getElementById('add-component');
            const componentSelect = document.getElementById('component-select');
            const propertyEditor = document.getElementById('property-editor');
            const propertiesForm = document.getElementById('properties-form');
            const saveJsonBtn = document.getElementById('save-json');
            const loadJsonInput = document.getElementById('load-json-input');
            const resizeCanvasBtn = document.getElementById('resize-canvas');
            const canvasWidthInput = document.getElementById('canvas-width');
            const canvasHeightInput = document.getElementById('canvas-height');
            const deleteComponentBtn = document.getElementById('delete-component');
            const fontPickerModal = document.getElementById('font-picker-modal');
            const closeFontModalBtn = document.getElementById('close-font-modal');
            const fontList = document.getElementById('font-list');
            const livePreviewBtn = document.getElementById('live-preview-btn');
            const previewModal = document.getElementById('preview-modal');
            const previewCanvas = document.getElementById('preview-canvas');
            const previewContent = document.getElementById('preview-content');
            const closePreviewBtn = document.getElementById('close-preview-btn');
            const fullscreenPreviewBtn = document.getElementById('fullscreen-preview-btn');

            let components = [];
            let selectedComponent = null;
            let componentIdCounter = 0;
            const googleFonts = [
                'Roboto', 'Open Sans', 'Lato', 'Montserrat', 'Oswald', 'Source Sans Pro', 
                'Raleway', 'Poppins', 'Nunito', 'Merriweather', 'Playfair Display', 'Ubuntu',
                'Lora', 'PT Sans', 'Slabo 27px'
            ];

            function loadGoogleFont(fontName) {
                if (!fontName || fontName === 'Inter') return;
                const fontId = `font-${fontName.replace(/\s/g, '-')}`;
                if (document.getElementById(fontId)) return;

                const link = document.createElement('link');
                link.id = fontId;
                link.rel = 'stylesheet';
                link.href = `https://fonts.googleapis.com/css2?family=${fontName.replace(/\s/g, '+')}&display=swap`;
                document.head.appendChild(link);
            }

            function openFontPicker() {
                fontList.innerHTML = '';
                googleFonts.forEach(font => {
                    loadGoogleFont(font);
                    const item = document.createElement('div');
                    item.textContent = font;
                    item.style.fontFamily = `'${font}', sans-serif`;
                    item.className = 'p-2 text-lg cursor-pointer hover:bg-gray-100 rounded';
                    item.addEventListener('click', () => {
                        if (selectedComponent) {
                            updateComponentProperty(selectedComponent.id, 'fontFamily', font);
                        }
                        closeFontPicker();
                    });
                    fontList.appendChild(item);
                });
                fontPickerModal.style.display = 'flex';
            }

            function closeFontPicker() {
                fontPickerModal.style.display = 'none';
            }

            closeFontModalBtn.addEventListener('click', closeFontPicker);
            fontPickerModal.addEventListener('click', (e) => {
                if (e.target === fontPickerModal) closeFontPicker();
            });

            const getComponentDefaults = (type) => {
                const base = {
                    textColor: '#000000',
                    fontSize: 14,
                    fontFamily: 'Inter',
                    bold: false,
                };
                 const textBase = { ...base, text: type };
                const placeholderImg = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxyZWN0IHdpZHRoPSIxMDAlIiBoZWlnaHQ9IjEwMCUiIGZpbGw9IiNlNWU3ZWIiLz48dGV4dCB4PSI1MCUiIHk9IjUwJSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE2IiBmaWxsPSIjY2FkMWQ4IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkeT0iLjNlbSI+SW1hZ2U8L3RleHQ+PC9zdmc+';

                switch (type) {
                    case 'Button': return { ...textBase, backgroundColor: '#ffffff', cornerRadius: 4 };
                    case 'Label': return { ...textBase, iconName: '' };
                    case 'TextBox': return { text: '', hintText: 'Enter text...', hintColor: '#9ca3af', backgroundColor: '#ffffff', ...base };
                    case 'TextArea': return { text: '', hintText: 'Enter text...', hintColor: '#9ca3af', backgroundColor: '#ffffff', ...base };
                    case 'Checkbox': return { text: 'Checkbox', checked: false, checkedColor: '#3b82f6', ...base };
                    case 'RadioGroup': return { label: 'Select an Option', options: 'Option 1\nOption 2', checkedValue: 'Option 1', checkedColor: '#3b82f6', ...base };
                    case 'Dropdown': return { text: 'Dropdown', options: 'Option 1\nOption 2', backgroundColor: '#ffffff', selectionColor: '#dbeafe', ...base };
                    case 'Slider': return { min: 0, max: 100, value: 50, progressColor: '#3b82f6', buttonColor: '#3b82f6' };
                    case 'Panel': return { backgroundColor: '#f3f4f6' };
                    case 'ProgressBar': return { value: 50, progressColor: '#3b82f6', trackColor: '#e5e7eb' };
                    case 'Spinner': return { min: 0, max: 100, value: 25, backgroundColor: '#ffffff', ...base };
                    case 'CardView': return { ...textBase, backgroundColor: '#ffffff', cornerRadius: 8, elevation: 2 };
                    case 'ToggleButton': return { checked: false, onColor: '#34d399', offColor: '#d1d5db' };
                    case 'Image': return { src: placeholderImg, cornerRadius: 0, opacity: 1, fit: 'cover' };
                    default: return textBase;
                }
            };

            resizeCanvasBtn.addEventListener('click', () => {
                canvas.style.width = `${canvasWidthInput.value}px`;
                canvas.style.height = `${canvasHeightInput.value}px`;
            });

            addComponentBtn.addEventListener('click', () => {
                const componentType = componentSelect.value;
                let id = `${componentType.toLowerCase()}_${componentIdCounter++}`;
                while (components.some(c => c.id === id)) {
                    id = `${componentType.toLowerCase()}_${componentIdCounter++}`;
                }
                
                const componentData = {
                    id: id, type: componentType, x: 50, y: 50,
                    width: 150, height: 40,
                    properties: getComponentDefaults(componentType)
                };
                
                if(componentType === 'Image' || componentType === 'RadioGroup') componentData.height = 100;
                if(componentType === 'Slider') componentData.width = 200;
                if(componentType === 'TextArea') componentData.height = 80;
                if(componentType === 'Panel' || componentType === 'CardView') { componentData.width = 200; componentData.height = 150; }
                if(componentType === 'ProgressBar' || componentType === 'Slider') componentData.height = 25;
                if(componentType === 'ToggleButton') { componentData.width = 60; componentData.height = 32; }
                if(componentType === 'Label') { componentData.width = 40; componentData.height = 40; }


                components.push(componentData);
                renderComponent(componentData);
                selectComponent(id);
            });

            function renderComponent(comp) {
                let el = document.getElementById(comp.id);
                if (!el) {
                    el = document.createElement('div');
                    el.id = comp.id;
                    el.className = 'component';
                    canvas.appendChild(el);
                    
                    const resizer = document.createElement('div');
                    resizer.className = 'resizer';
                    el.appendChild(resizer);
                    
                    makeDraggable(el);
                    makeResizable(el, resizer);

                    el.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectComponent(comp.id);
                    });
                }

                el.style.left = `${comp.x}px`;
                el.style.top = `${comp.y}px`;
                el.style.width = `${comp.width}px`;
                el.style.height = `${comp.height}px`;

                el.innerHTML = getComponentHTML(comp) + (el.querySelector('.resizer')?.outerHTML || '<div class="resizer"></div>');
                makeResizable(el, el.querySelector('.resizer'));

                if (selectedComponent && selectedComponent.id === comp.id) {
                    el.classList.add('selected');
                }
            }

            function getComponentHTML(comp) {
                const p = comp.properties;
                const baseStyles = `color:${p.textColor}; font-size:${p.fontSize}px; font-family:'${p.fontFamily}', sans-serif; font-weight:${p.bold ? 'bold' : 'normal'};`;
                let wrapperStyles = `background-color:${p.backgroundColor || 'white'}; border-radius:${p.cornerRadius || 0}px;`;
                
                switch(comp.type) {
                    case 'Image':
                        return `<div class="component-render-wrapper" style="padding:0; border:none; background:transparent;">
                                    <img src="${p.src}" style="width:100%; height:100%; object-fit:${p.fit}; border-radius:${p.cornerRadius}px; opacity:${p.opacity};" />
                                </div>`;
                    case 'Button':
                    case 'CardView':
                         if(comp.type === 'CardView') wrapperStyles += ` box-shadow: 0 ${p.elevation*2}px ${p.elevation*3}px rgba(0,0,0,0.1);`;
                         return `<div class="component-render-wrapper" style="${wrapperStyles}"><span style="${baseStyles}">${p.text}</span></div>`;
                    case 'Panel':
                         return `<div class="component-render-wrapper" style="${wrapperStyles}"></div>`;
                    case 'Label':
                        if (p.iconName && p.iconName.trim() !== '') {
                            const iconStyles = `font-family: 'Material Symbols Outlined'; font-size: ${p.fontSize}px; color:${p.textColor};`;
                            return `<div class="component-render-wrapper" style="border:none; background:transparent;"><span class="material-symbols-outlined" style="${iconStyles}">${p.iconName}</span></div>`;
                        }
                        return `<div class="component-render-wrapper" style="border:none; background:transparent;"><span style="${baseStyles}">${p.text}</span></div>`;
                    case 'TextBox':
                    case 'TextArea':
                        const hint = `<span style='color:${p.hintColor}; font-family:"Inter", sans-serif;'>${p.hintText}</span>`;
                        const align = comp.type === 'TextArea' ? 'align-self: flex-start;' : '';
                        return `<div class="component-render-wrapper" style="${wrapperStyles}">
                                    <span style="${baseStyles} width: 100%; text-align: left; ${align}">${p.text || hint}</span>
                                </div>`;
                    case 'Checkbox':
                        return `<div class="component-render-wrapper" style="border:none; background:transparent; justify-content:flex-start;">
                                    <div style="display:flex; align-items:center; gap:8px;">
                                        <div style="width:16px; height:16px; border:1px solid #9ca3af; display:flex; align-items:center; justify-content:center; background:${p.checked ? p.checkedColor : 'white'}; border-radius: 2px">
                                            ${p.checked ? '<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"></path></svg>' : ''}
                                        </div>
                                        <span style="${baseStyles}">${p.text}</span>
                                    </div>
                                </div>`;
                    case 'RadioGroup':
                        let radioHTML = `<div style="${baseStyles} margin-bottom: 8px;">${p.label}</div>`;
                        const options = p.options.split('\n');
                        options.forEach(opt => {
                            const isChecked = opt === p.checkedValue;
                            radioHTML += `<div style="display:flex; align-items:center; gap:8px; margin-bottom: 4px;">
                                            <div style="width:16px; height:16px; border:1px solid #9ca3af; display:flex; align-items:center; justify-content:center; background:${isChecked ? p.checkedColor : 'white'}; border-radius:50%">
                                                ${isChecked ? `<div style="width:8px; height:8px; background:white; border-radius:50%;"></div>` : ''}
                                            </div>
                                            <span style="${baseStyles}">${opt}</span>
                                        </div>`;
                        });
                        return `<div class="component-render-wrapper" style="border:none; background:transparent; flex-direction: column; align-items: flex-start;">${radioHTML}</div>`;
                    case 'ProgressBar':
                        return `<div style="width:100%; height:100%; background-color:${p.trackColor}; border-radius: 999px; position:relative; display:flex; align-items:center; overflow:hidden;">
                                    <div style="width:${p.value}%; height:100%; background-color:${p.progressColor}; border-radius: 999px;"></div>
                                </div>`;
                    case 'Slider':
                        const sliderPercent = (p.value - p.min) / (p.max - p.min) * 100;
                        return `<div class="component-render-wrapper" style="border:none; background:transparent;">
                                    <div style="width:100%; height:6px; background:#e5e7eb; border-radius:3px; position:relative;">
                                        <div style="position:absolute; left:0; top:0; height:100%; width:${sliderPercent}%; background:${p.progressColor}; border-radius:3px;"></div>
                                        <div style="position:absolute; left:${sliderPercent}%; transform:translateX(-50%); top:-6px; width:18px; height:18px; background:${p.buttonColor}; border-radius:50%; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2);"></div>
                                    </div>
                                </div>`;
                    case 'ToggleButton':
                        return `<div class="component-render-wrapper" style="border:none; background:transparent;">
                                    <div style="width:100%; height:100%; background-color:${p.checked ? p.onColor : p.offColor}; border-radius:999px; position:relative; transition: background-color 0.2s ease;">
                                        <div style="position:absolute; top:4px; left:4px; width:24px; height:24px; background:white; border-radius:50%; box-shadow:0 1px 3px rgba(0,0,0,0.2); transition: transform 0.2s ease; transform: ${p.checked ? 'translateX(28px)' : 'translateX(0)'};"></div>
                                    </div>
                                </div>`;
                    case 'Spinner':
                        return `<div class="component-render-wrapper" style="background-color:${p.backgroundColor}; justify-content:space-between; padding:0;">
                                    <button class="h-full px-2" style="font-size:${p.fontSize}px; color:${p.textColor};">-</button>
                                    <span style="${baseStyles}">${p.value}</span>
                                    <button class="h-full px-2" style="font-size:${p.fontSize}px; color:${p.textColor};">+</button>
                                </div>`;
                    default:
                        return `<div class="component-render-wrapper" style="${wrapperStyles}"><span style="${baseStyles}">${p.text}</span></div>`;
                }
            }
            
            deleteComponentBtn.addEventListener('click', () => {
                if (!selectedComponent) return;
                document.getElementById(selectedComponent.id)?.remove();
                components = components.filter(c => c.id !== selectedComponent.id);
                selectedComponent = null;
                propertyEditor.classList.add('hidden');
            });

            function selectComponent(id) {
                selectedComponent = components.find(c => c.id === id) || null;
                document.querySelectorAll('.component').forEach(el => el.classList.remove('selected'));
                if (selectedComponent) {
                    document.getElementById(id)?.classList.add('selected');
                    propertyEditor.classList.remove('hidden');
                    populatePropertyEditor(selectedComponent);
                } else {
                    propertyEditor.classList.add('hidden');
                }
            }

            canvas.addEventListener('click', () => selectComponent(null));

            function populatePropertyEditor(component) {
                propertiesForm.innerHTML = '';
                const addField = (parent, type, label, value, key, options = {}) => {
                    const div = document.createElement('div');
                    const labelEl = document.createElement('label');
                    labelEl.className = 'block text-sm font-medium text-gray-700';
                    labelEl.textContent = label;
                    
                    let input;
                    if (type === 'file-button' || type === 'font-button') {
                        if (type === 'font-button') {
                            const btn = document.createElement('button');
                            btn.type = 'button';
                            btn.textContent = label;
                            btn.className = 'w-full text-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 cursor-pointer';
                            btn.addEventListener('click', openFontPicker);
                            div.appendChild(btn);
                        } else { // file-button
                            labelEl.htmlFor = `file-input-${component.id}`;
                            labelEl.className += ' w-full text-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 cursor-pointer';
                            input = document.createElement('input');
                            input.type = 'file';
                            input.id = `file-input-${component.id}`;
                            input.className = 'hidden';
                            input.accept = 'image/*';
                            input.addEventListener('change', (e) => {
                                const file = e.target.files[0];
                                if (!file) return;
                                const reader = new FileReader();
                                reader.onload = (readEvent) => {
                                    updateComponentProperty(component.id, 'src', readEvent.target.result);
                                };
                                reader.readAsDataURL(file);
                            });
                            div.appendChild(labelEl);
                            div.appendChild(input);
                        }
                    } else {
                       div.appendChild(labelEl);
                        if (type === 'textarea') {
                            input = document.createElement('textarea');
                            input.rows = 3;
                        } else if (type === 'select') {
                            input = document.createElement('select');
                            options.choices.forEach(c => {
                                const opt = document.createElement('option');
                                opt.value = c;
                                opt.textContent = c.charAt(0).toUpperCase() + c.slice(1);
                                input.appendChild(opt);
                            });
                        } else {
                            input = document.createElement('input');
                            input.type = type;
                            if (options.step) input.step = options.step;
                            if (options.min) input.min = options.min;
                            if (options.max) input.max = options.max;
                        }

                        input.value = value;
                        input.dataset.key = key;
                        input.className = 'mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500';
                        if (type === 'color') input.className += ' h-10';
                        if (type === 'checkbox') {
                           input.checked = value;
                           input.className = 'h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500';
                           div.className = 'flex items-center gap-x-2';
                           div.insertBefore(input, labelEl);
                        }

                        input.addEventListener(type === 'checkbox' ? 'change' : 'input', (e) => {
                            const originalId = component.id;
                            const val = type === 'checkbox' ? e.target.checked : e.target.value;
                            updateComponentProperty(originalId, key, val, e.target);
                        });
                        div.appendChild(input);
                    }
                    parent.appendChild(div);
                };

                addField(propertiesForm, 'text', 'ID', component.id, 'id');

                const p = component.properties;
                if (component.type === 'Image') {
                    addField(propertiesForm, 'file-button', 'Upload Image', null, 'src');
                    addField(propertiesForm, 'number', 'Corner Radius (px)', p.cornerRadius, 'cornerRadius', {min: 0});
                    addField(propertiesForm, 'range', `Opacity (${p.opacity})`, p.opacity, 'opacity', {min: 0, max: 1, step: 0.1});
                    addField(propertiesForm, 'select', 'Image Fit', p.fit, 'fit', { choices: ['fill', 'contain', 'cover', 'none', 'scale-down'] });
                } else {
                    for (const key in p) {
                        const label = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                        let type = 'text';
                        if (key.includes('Color')) type = 'color';
                        else if (typeof p[key] === 'number') type = 'number';
                        else if (typeof p[key] === 'boolean') type = 'checkbox';
                        else if (key === 'options') type = 'textarea';
                        
                        if (key === 'fontFamily') {
                             if(component.type === 'Label' && p.iconName) {} 
                             else {
                                addField(propertiesForm, 'font-button', `Font: ${p[key]}`, p[key], key);
                             }
                        } else if (component.type === 'ProgressBar' && key === 'percentagePosition') {
                             addField(propertiesForm, 'select', label, p[key], key, { choices: ['center', 'left', 'right', 'none'] });
                        } else {
                             addField(propertiesForm, type, label, p[key], key);
                        }
                    }
                }
            }

            function updateComponentProperty(id, key, value, targetElement) {
                const component = components.find(c => c.id === id);
                if (!component) return;
                
                if (key === 'id') {
                    const isDuplicate = components.some(c => c.id === value && c.id !== id);
                    if (isDuplicate || value.trim() === '') {
                        if(targetElement) targetElement.classList.add('id-error');
                        return;
                    }
                    if(targetElement) targetElement.classList.remove('id-error');
                    
                    document.getElementById(id).id = value;
                    component.id = value;
                    if(selectedComponent.id === id) selectedComponent.id = value;
                    return;
                }

                if (key === 'fontFamily') {
                    loadGoogleFont(value);
                }

                if (typeof component.properties[key] === 'number') {
                    value = parseFloat(value) || 0;
                }
                component.properties[key] = value;
                renderComponent(component);
                
                if ((key === 'fontFamily' || (component.type === 'Label' && key === 'iconName')) && selectedComponent && selectedComponent.id === id) {
                    populatePropertyEditor(component);
                }

                if (targetElement && targetElement.type === 'range') {
                    const label = targetElement.closest('div').querySelector('label');
                    if (label) {
                        label.textContent = `${label.textContent.split('(')[0].trim()} (${value})`;
                    }
                }
            }

            function makeDraggable(element) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                element.onmousedown = e => {
                    if (e.target.classList.contains('resizer')) return;
                    e.preventDefault();
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = () => {
                        document.onmouseup = null;
                        document.onmousemove = null;
                        const component = components.find(c => c.id === element.id);
                        if (component) {
                            component.x = element.offsetLeft;
                            component.y = element.offsetTop;
                        }
                    };
                    document.onmousemove = me => {
                        me.preventDefault();
                        pos1 = pos3 - me.clientX;
                        pos2 = pos4 - me.clientY;
                        pos3 = me.clientX;
                        pos4 = me.clientY;
                        
                        let newTop = element.offsetTop - pos2;
                        let newLeft = element.offsetLeft - pos1;

                        if (newLeft < 0) newLeft = 0;
                        if (newTop < 0) newTop = 0;
                        if (newLeft + element.offsetWidth > canvas.offsetWidth) newLeft = canvas.offsetWidth - element.offsetWidth;
                        if (newTop + element.offsetHeight > canvas.offsetHeight) newTop = canvas.offsetHeight - element.offsetHeight;

                        element.style.top = `${newTop}px`;
                        element.style.left = `${newLeft}px`;
                    };
                };
            }

            function makeResizable(element, resizer) {
                if (!resizer) return;
                resizer.addEventListener('mousedown', e => {
                    e.stopPropagation();
                    window.addEventListener('mousemove', resize);
                    window.addEventListener('mouseup', stopResize);
                });

                function resize(e) {
                    let newWidth = (e.clientX - element.getBoundingClientRect().left);
                    let newHeight = (e.clientY - element.getBoundingClientRect().top);
                    if (newWidth < 20) newWidth = 20;
                    if (newHeight < 20) newHeight = 20;
                    element.style.width = `${newWidth}px`;
                    element.style.height = `${newHeight}px`;
                }

                function stopResize() {
                    window.removeEventListener('mousemove', resize);
                    window.removeEventListener('mouseup', stopResize);
                    const component = components.find(c => c.id === element.id);
                    if (component) {
                        component.width = element.offsetWidth;
                        component.height = element.offsetHeight;
                    }
                }
            }

            function openPreview() {
                previewCanvas.innerHTML = '';
                previewCanvas.style.width = canvas.style.width;
                previewCanvas.style.height = canvas.style.height;

                let dynamicStyles = document.getElementById('dynamic-preview-styles');
                if (dynamicStyles) dynamicStyles.remove();
                dynamicStyles = document.createElement('style');
                dynamicStyles.id = 'dynamic-preview-styles';
                document.head.appendChild(dynamicStyles);

                components.forEach(comp => {
                    const p = comp.properties;
                    const elWrapper = document.createElement('div');
                    elWrapper.className = 'preview-component';
                    elWrapper.style.left = `${comp.x}px`;
                    elWrapper.style.top = `${comp.y}px`;
                    elWrapper.style.width = `${comp.width}px`;
                    elWrapper.style.height = `${comp.height}px`;

                    let el;
                    switch(comp.type) {
                        case 'Button':
                            el = document.createElement('button');
                            el.textContent = p.text;
                            el.className = 'preview-button';
                            el.style.transition = 'transform 0.1s ease, filter 0.1s ease';
                            el.style.backgroundColor = p.backgroundColor;
                            el.style.color = p.textColor;
                            el.style.fontSize = `${p.fontSize}px`;
                            el.style.fontFamily = `'${p.fontFamily}', sans-serif`;
                            el.style.fontWeight = p.bold ? 'bold' : 'normal';
                            el.style.borderRadius = `${p.cornerRadius}px`;
                            el.style.border = '1px solid #9ca3af';
                            break;
                        case 'TextBox':
                            el = document.createElement('input');
                            el.type = 'text';
                            el.placeholder = p.hintText;
                            el.value = p.text;
                            el.style.color = p.textColor;
                            el.style.backgroundColor = p.backgroundColor;
                            el.style.fontSize = `${p.fontSize}px`;
                            el.style.fontFamily = `'${p.fontFamily}', sans-serif`;
                            el.style.fontWeight = p.bold ? 'bold' : 'normal';
                            break;
                        case 'TextArea':
                             el = document.createElement('textarea');
                             el.placeholder = p.hintText;
                             el.value = p.text;
                             el.style.color = p.textColor;
                             el.style.backgroundColor = p.backgroundColor;
                             el.style.fontSize = `${p.fontSize}px`;
                             el.style.fontFamily = `'${p.fontFamily}', sans-serif`;
                             el.style.fontWeight = p.bold ? 'bold' : 'normal';
                             break;
                        case 'Checkbox':
                            el = document.createElement('div');
                            el.className = 'flex items-center justify-start gap-2';
                            const input = document.createElement('input');
                            input.type = 'checkbox';
                            input.checked = p.checked;
                            const label = document.createElement('label');
                            label.textContent = p.text;
                            label.style.color = p.textColor;
                            label.style.fontSize = `${p.fontSize}px`;
                            label.style.fontFamily = `'${p.fontFamily}', sans-serif`;
                            label.style.fontWeight = p.bold ? 'bold' : 'normal';
                            el.append(input, label);
                            break;
                        case 'RadioGroup':
                            el = document.createElement('div');
                            el.className = 'flex flex-col items-start justify-center gap-2';
                            const groupLabel = document.createElement('label');
                            groupLabel.textContent = p.label;
                            groupLabel.style.color = p.textColor;
                            groupLabel.style.fontSize = `${p.fontSize}px`;
                            groupLabel.style.fontFamily = `'${p.fontFamily}', sans-serif`;
                            groupLabel.style.fontWeight = p.bold ? 'bold' : 'normal';
                            groupLabel.style.marginBottom = '4px';
                            el.appendChild(groupLabel);
                            p.options.split('\n').forEach(opt => {
                                const optionWrapper = document.createElement('div');
                                optionWrapper.className = 'flex items-center gap-2';
                                const radioInput = document.createElement('input');
                                radioInput.type = 'radio';
                                radioInput.name = comp.id;
                                radioInput.value = opt;
                                radioInput.checked = opt === p.checkedValue;
                                const optionLabel = document.createElement('label');
                                optionLabel.textContent = opt;
                                optionLabel.style.color = p.textColor;
                                optionLabel.style.fontSize = `${p.fontSize}px`;
                                optionLabel.style.fontFamily = `'${p.fontFamily}', sans-serif`;
                                optionLabel.style.fontWeight = p.bold ? 'bold' : 'normal';
                                optionLabel.style.whiteSpace = 'nowrap';
                                optionWrapper.append(radioInput, optionLabel);
                                el.appendChild(optionWrapper);
                            });
                            break;
                        case 'Slider':
                            el = document.createElement('input');
                            el.type = 'range';
                            el.min = p.min;
                            el.max = p.max;
                            el.value = p.value;
                            el.className = `preview-slider-${comp.id}`;
                            el.style.height = '6px'; // Fix for vertical alignment
                            el.style.margin = 'auto 0'; // Center vertically

                            const updateSliderStyle = (target) => {
                                const newPercent = ((target.value - p.min) / (p.max - p.min)) * 100;
                                target.style.background = `linear-gradient(to right, ${p.progressColor} 0%, ${p.progressColor} ${newPercent}%, #e5e7eb ${newPercent}%, #e5e7eb 100%)`;
                            };
                            
                            dynamicStyles.innerHTML += `
                                .preview-slider-${comp.id} { -webkit-appearance: none; appearance: none; width: 100%; border-radius: 3px; outline: none; }
                                .preview-slider-${comp.id}::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: ${p.buttonColor}; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
                                .preview-slider-${comp.id}::-moz-range-thumb { width: 18px; height: 18px; background: ${p.buttonColor}; border-radius: 50%; cursor: pointer; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
                            `;
                            
                            el.addEventListener('input', (e) => updateSliderStyle(e.target));
                            setTimeout(() => updateSliderStyle(el), 0);
                            break;
                         case 'Dropdown':
                            el = document.createElement('select');
                            el.className = `preview-dropdown-${comp.id}`;
                            dynamicStyles.innerHTML += `
                                .preview-dropdown-${comp.id} option:hover { background-color: ${p.selectionColor} !important; }
                            `;
                            const options = p.options.split('\n');
                            options.forEach(opt => {
                                const optionEl = document.createElement('option');
                                optionEl.value = opt;
                                optionEl.textContent = opt;
                                el.appendChild(optionEl);
                            });
                             el.style.backgroundColor = p.backgroundColor;
                             el.style.color = p.textColor;
                             el.style.fontSize = `${p.fontSize}px`;
                             el.style.fontFamily = `'${p.fontFamily}', sans-serif`;
                             el.style.fontWeight = p.bold ? 'bold' : 'normal';
                            break;
                        case 'ToggleButton':
                            el = document.createElement('label');
                            el.className = 'relative inline-flex items-center cursor-pointer';
                            const toggleInput = document.createElement('input');
                            toggleInput.type = 'checkbox';
                            toggleInput.className = 'sr-only peer';
                            toggleInput.checked = p.checked;
                            const toggleDiv = document.createElement('div');
                            toggleDiv.className = "w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600";
                            toggleDiv.style.backgroundColor = p.checked ? p.onColor : p.offColor;
                            toggleInput.addEventListener('change', (e) => {
                                toggleDiv.style.backgroundColor = e.target.checked ? p.onColor : p.offColor;
                            });
                            el.append(toggleInput, toggleDiv);
                            break;
                        case 'Spinner':
                            el = document.createElement('div');
                            el.className = 'flex items-center justify-between border border-gray-400 rounded';
                            el.style.backgroundColor = p.backgroundColor || 'white';
                            const minusBtn = document.createElement('button');
                            minusBtn.textContent = '-';
                            minusBtn.className = 'px-2';
                            minusBtn.style.fontSize = `${p.fontSize}px`;
                            minusBtn.style.color = p.textColor;
                            minusBtn.style.fontWeight = p.bold ? 'bold' : 'normal';
                            const valueSpan = document.createElement('span');
                            valueSpan.textContent = p.value;
                            valueSpan.style.color = p.textColor;
                            valueSpan.style.fontSize = `${p.fontSize}px`;
                            valueSpan.style.fontFamily = `'${p.fontFamily}', sans-serif`;
                            valueSpan.style.fontWeight = p.bold ? 'bold' : 'normal';
                            const plusBtn = document.createElement('button');
                            plusBtn.textContent = '+';
                            plusBtn.className = 'px-2';
                            plusBtn.style.fontSize = `${p.fontSize}px`;
                            plusBtn.style.color = p.textColor;
                            plusBtn.style.fontWeight = p.bold ? 'bold' : 'normal';
                            
                            minusBtn.addEventListener('click', () => {
                                let val = parseInt(valueSpan.textContent);
                                if (val > p.min) {
                                    valueSpan.textContent = val - 1;
                                }
                            });
                            plusBtn.addEventListener('click', () => {
                                let val = parseInt(valueSpan.textContent);
                                if (val < p.max) {
                                    valueSpan.textContent = val + 1;
                                }
                            });
                            el.append(minusBtn, valueSpan, plusBtn);
                            break;
                        default:
                            el = document.createElement('div');
                            el.innerHTML = getComponentHTML(comp);
                            const innerEl = el.firstElementChild;
                            innerEl.style.width = '100%';
                            innerEl.style.height = '100%';
                            el = innerEl;
                    }
                    
                    if (el) {
                        elWrapper.appendChild(el);
                        previewCanvas.appendChild(elWrapper);
                    }
                });

                previewModal.style.display = 'flex';
            }

            function closePreview() {
                previewModal.style.display = 'none';
                if (document.fullscreenElement) {
                    document.exitFullscreen();
                }
            }

            function toggleFullScreen() {
                if (!document.fullscreenElement) {
                    previewContent.requestFullscreen().catch(err => {
                        alert(`Error: ${err.message}`);
                    });
                     fullscreenPreviewBtn.textContent = 'Exit Full Screen';
                } else {
                    document.exitFullscreen();
                     fullscreenPreviewBtn.textContent = 'Full Screen';
                }
            }
            
            livePreviewBtn.addEventListener('click', openPreview);
            closePreviewBtn.addEventListener('click', closePreview);
            fullscreenPreviewBtn.addEventListener('click', toggleFullScreen);
            document.addEventListener('fullscreenchange', () => {
                if (!document.fullscreenElement) {
                    fullscreenPreviewBtn.textContent = 'Full Screen';
                }
            });

            saveJsonBtn.addEventListener('click', () => {
                const layout = {
                    canvas: { width: canvas.offsetWidth, height: canvas.offsetHeight },
                    components: components
                };
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(layout, null, 2));
                const a = document.createElement('a');
                a.href = dataStr;
                a.download = "layout.json";
                a.click();
            });

            loadJsonInput.addEventListener('change', (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const layout = JSON.parse(e.target.result);
                        loadLayout(layout);
                    } catch (error) {
                        alert("Invalid JSON file.");
                    }
                };
                reader.readAsText(file);
                event.target.value = '';
            });

            function loadLayout(layout) {
                canvas.style.width = `${layout.canvas.width}px`;
                canvas.style.height = `${layout.canvas.height}px`;
                canvasWidthInput.value = layout.canvas.width;
                canvasHeightInput.value = layout.canvas.height;
                
                canvas.innerHTML = '';
                components = layout.components;

                const idSet = new Set();
                const duplicateIds = new Set();
                components.forEach(c => {
                    if (idSet.has(c.id)) {
                        duplicateIds.add(c.id);
                    }
                    idSet.add(c.id);
                    if (c.properties.fontFamily && c.properties.fontFamily !== 'Inter') {
                        loadGoogleFont(c.properties.fontFamily);
                    }
                });

                if (duplicateIds.size > 0) {
                    alert(`Warning: Duplicate IDs found: ${Array.from(duplicateIds).join(', ')}.`);
                }
                
                componentIdCounter = components.length ? Math.max(0, ...components.map(c => parseInt(c.id.split('_').pop()) || 0).filter(Number.isFinite)) + 1 : 0;
                
                components.forEach(comp => renderComponent(comp));
                selectComponent(null);
            }
        });
    </script>

</body>
</html>
