<!-- START OF FILE Paste January 18, 2026 - 12:15PM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NVLib v4 Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Blueprint Grid Pattern */
        .canvas {
            background-color: #ffffff;
            position: relative;
            overflow: hidden;
            background-image: 
                linear-gradient(rgba(99, 102, 241, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(99, 102, 241, 0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            border-radius: 16px;
        }

        .component {
            position: absolute;
            cursor: move;
            border: 1px dashed transparent;
            user-select: none;
            box-sizing: border-box;
            transition: box-shadow 0.2s, outline 0.2s;
        }

        .component:hover {
            border-color: #a5b4fc; /* Light indigo hover */
        }

        .component.selected {
            outline: 2px solid #6366f1; /* Indigo-500 */
            box-shadow: 0 10px 25px -5px rgba(99, 102, 241, 0.4), 0 8px 10px -6px rgba(99, 102, 241, 0.1);
            z-index: 1000 !important;
        }

        .resizer {
            width: 12px;
            height: 12px;
            background: #6366f1;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            right: -6px;
            bottom: -6px;
            cursor: se-resize;
            display: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .component.selected .resizer { display: block; }

        .component-render-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-sizing: border-box;
        }

        /* Material Symbols tweak */
        .material-symbols-rounded {
          font-variation-settings: 'FILL' 1, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Animations */
        .btn-bounce:active { transform: scale(0.95); }
    </style>
</head>
<body class="h-screen flex flex-col text-gray-800">

    <!-- Vibrant Header -->
    <header class="bg-gradient-to-r from-indigo-600 via-purple-600 to-pink-500 text-white shadow-lg p-3 flex justify-between items-center z-30">
        <div class="flex items-center gap-4 pl-2">
            <div class="bg-white/20 p-2 rounded-xl backdrop-blur-sm">
                <span class="material-symbols-rounded text-2xl">view_quilt</span>
            </div>
            <div>
                <h1 class="text-xl font-bold tracking-tight">NVLib v4 Builder</h1>
                <a href="docs.html" target="_blank" class="text-xs font-medium text-indigo-100 hover:text-white flex items-center gap-1 opacity-80 hover:opacity-100 transition">
                    Read Documentation <span class="material-symbols-rounded text-[10px]">open_in_new</span>
                </a>
            </div>
        </div>

        <div class="flex items-center gap-4 bg-white/10 px-4 py-2 rounded-full backdrop-blur-md border border-white/10">
            <!-- Window Title -->
            <div class="flex items-center gap-2 border-r border-white/20 pr-4">
                <span class="material-symbols-rounded text-indigo-200 text-lg">title</span>
                <input type="text" id="window-title" value="My App" class="bg-transparent border-none text-white placeholder-indigo-200 text-sm font-medium focus:ring-0 focus:outline-none w-32" placeholder="App Title">
            </div>
            
            <!-- Canvas Size -->
            <div class="flex items-center gap-2 text-sm font-mono">
                <input type="number" id="canvas-width" value="800" class="w-14 bg-black/20 border-none rounded-md text-center py-1 text-white focus:ring-1 focus:ring-white/50">
                <span class="text-indigo-200">Ã—</span>
                <input type="number" id="canvas-height" value="600" class="w-14 bg-black/20 border-none rounded-md text-center py-1 text-white focus:ring-1 focus:ring-white/50">
                <button id="resize-canvas" class="p-1 hover:bg-white/20 rounded-full transition" title="Apply Size">
                    <span class="material-symbols-rounded text-lg">check</span>
                </button>
            </div>
        </div>

        <div class="flex items-center gap-3 pr-2">
            <button id="live-preview-btn" class="btn-bounce flex items-center gap-2 px-5 py-2 bg-emerald-400 hover:bg-emerald-300 text-emerald-900 text-sm font-bold rounded-full shadow-lg transition-all">
                <span class="material-symbols-rounded text-lg">play_arrow</span> Preview
            </button>
            <div class="h-8 w-px bg-white/20 mx-1"></div>
            <button id="save-json" class="btn-bounce flex items-center gap-2 px-4 py-2 bg-white text-indigo-600 text-sm font-bold rounded-full shadow hover:bg-indigo-50 transition-all">
                <span class="material-symbols-rounded text-lg">save</span> Save
            </button>
            <label for="load-json-input" class="btn-bounce flex items-center gap-2 px-4 py-2 bg-indigo-800/50 hover:bg-indigo-800 text-white text-sm font-bold rounded-full cursor-pointer transition-all border border-indigo-400/30">
                <span class="material-symbols-rounded text-lg">upload_file</span> Load
            </label>
            <input type="file" id="load-json-input" class="hidden" accept=".json">
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left Sidebar: Components -->
        <aside class="w-72 bg-white border-r border-gray-200 flex flex-col z-20 shadow-[4px_0_24px_rgba(0,0,0,0.02)]">
            <div class="p-5">
                <h2 class="text-xs font-bold uppercase tracking-wider text-gray-400 mb-4 ml-1">UI Components</h2>
                
                <div class="relative mb-4">
                    <select id="component-select" class="w-full p-3 pl-10 text-sm bg-gray-50 border border-gray-200 rounded-xl appearance-none focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition font-medium text-gray-700 cursor-pointer">
                        <optgroup label="Basic">
                            <option value="Button">Button</option>
                            <option value="Label">Label</option>
                            <option value="Image">Image</option>
                        </optgroup>
                        <optgroup label="Inputs">
                            <option value="TextBox">Text Input</option>
                            <option value="TextArea">Text Area</option>
                            <option value="Spinner">Number Spinner</option>
                            <option value="Slider">Slider</option>
                        </optgroup>
                        <optgroup label="Selection">
                            <option value="Checkbox">Checkbox</option>
                            <option value="ToggleButton">Toggle Switch</option>
                            <option value="RadioGroup">Radio Group</option>
                            <option value="Dropdown">Dropdown Menu</option>
                        </optgroup>
                        <optgroup label="Containers & Misc">
                            <option value="Panel">Panel (Flat)</option>
                            <option value="CardView">Card (Elevated)</option>
                            <option value="ProgressBar">Progress Bar</option>
                        </optgroup>
                    </select>
                    <span class="material-symbols-rounded absolute left-3 top-3 text-gray-400 pointer-events-none">widgets</span>
                    <span class="material-symbols-rounded absolute right-3 top-3 text-gray-400 pointer-events-none text-sm">expand_more</span>
                </div>

                <button id="add-component" class="btn-bounce w-full py-3 bg-indigo-50 hover:bg-indigo-100 text-indigo-600 font-bold rounded-xl transition flex items-center justify-center gap-2 border border-indigo-200 border-dashed hover:border-solid">
                    <span class="material-symbols-rounded">add_circle</span> Add to Canvas
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto px-5 pb-5">
                <div class="p-4 bg-gradient-to-br from-purple-50 to-indigo-50 rounded-2xl border border-purple-100 text-xs text-indigo-900/80 leading-relaxed shadow-sm">
                    <div class="flex items-center gap-2 mb-2 font-bold text-indigo-700">
                        <span class="material-symbols-rounded text-base">tips_and_updates</span> Quick Tips
                    </div>
                    <ul class="space-y-2 list-disc list-inside opacity-90">
                        <li>Right-click to layer or duplicate.</li>
                        <li>Use <code class="bg-white px-1.5 py-0.5 rounded border border-indigo-100 font-mono text-indigo-600">app.screen.id</code> in Python.</li>
                        <li>Panels should be at the back.</li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- Center: Canvas Area -->
        <main class="flex-1 bg-gray-100/50 overflow-auto flex items-center justify-center p-10 relative">
            <div id="canvas" class="canvas shadow-2xl transition-all duration-300" style="width: 800px; height: 600px;"></div>
        </main>

        <!-- Right Sidebar: Properties -->
        <aside id="property-editor" class="w-80 bg-white border-l border-gray-200 overflow-y-auto hidden z-20 shadow-[-4px_0_24px_rgba(0,0,0,0.02)] flex flex-col">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 backdrop-blur">
                <div class="flex items-center gap-2 text-gray-700 font-bold">
                    <span class="material-symbols-rounded text-indigo-500">tune</span> Properties
                </div>
                <button id="close-props" class="p-1 hover:bg-gray-200 rounded-full transition text-gray-400 hover:text-gray-600">
                    <span class="material-symbols-rounded text-lg">close</span>
                </button>
            </div>
            
            <div id="properties-form" class="p-5 space-y-5 flex-1">
                <!-- Properties injected here -->
            </div>

            <div class="p-5 border-t border-gray-100 bg-red-50/30">
                <button id="delete-component" class="btn-bounce w-full py-2.5 bg-white border border-red-200 text-red-500 font-bold rounded-xl hover:bg-red-500 hover:text-white transition shadow-sm flex items-center justify-center gap-2">
                    <span class="material-symbols-rounded text-lg">delete</span> Delete Component
                </button>
            </div>
        </aside>
    </div>

    <!-- ðŸŸ¢ Context Menu (FIXED Z-INDEX) -->
    <div id="context-menu" class="hidden fixed bg-white/90 backdrop-blur-md shadow-2xl rounded-2xl p-1.5 z-[9999] border border-gray-100 w-56 text-sm transform transition-all scale-100 origin-top-left">
        <a href="#" data-action="duplicate" class="flex items-center gap-3 px-3 py-2.5 text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 rounded-xl transition font-medium">
            <span class="material-symbols-rounded text-lg text-gray-400">content_copy</span> Duplicate
        </a>
        <div class="h-px bg-gray-200 my-1 mx-2"></div>
        <a href="#" data-action="bring-to-front" class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
            <span class="material-symbols-rounded text-lg text-gray-400">vertical_align_top</span> Bring to Front
        </a>
        <a href="#" data-action="send-to-back" class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
            <span class="material-symbols-rounded text-lg text-gray-400">vertical_align_bottom</span> Send to Back
        </a>
        <div class="h-px bg-gray-200 my-1 mx-2"></div>
        <a href="#" data-action="bring-forward" class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
            <span class="material-symbols-rounded text-lg text-gray-400">keyboard_arrow_up</span> Step Up
        </a>
        <a href="#" data-action="send-backward" class="flex items-center gap-3 px-3 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition">
            <span class="material-symbols-rounded text-lg text-gray-400">keyboard_arrow_down</span> Step Down
        </a>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 z-[10000] hidden bg-gray-900/60 backdrop-blur-sm flex items-center justify-center p-8">
        <div class="bg-white rounded-2xl shadow-2xl flex flex-col w-full h-full max-w-6xl overflow-hidden border border-white/20">
            <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-800 flex items-center gap-2 text-lg">
                    <span class="material-symbols-rounded text-emerald-500 bg-emerald-100 p-1 rounded-lg">play_arrow</span> Live Preview
                </h3>
                <div class="flex gap-3">
                    <button id="fullscreen-preview-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-600 rounded-full hover:bg-gray-50 text-xs font-bold uppercase tracking-wide transition shadow-sm">Fullscreen</button>
                    <button id="close-preview-btn" class="px-4 py-2 bg-gray-800 text-white rounded-full hover:bg-black text-xs font-bold uppercase tracking-wide transition shadow-lg">Close</button>
                </div>
            </div>
            <div class="flex-1 bg-gray-100 overflow-auto p-12 flex justify-center items-start">
                <div id="preview-canvas" class="bg-white shadow-xl rounded-xl transition-all relative border border-gray-200"></div>
            </div>
        </div>
    </div>

    <!-- Logic Script -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const canvas = document.getElementById('canvas');
            const addComponentBtn = document.getElementById('add-component');
            const componentSelect = document.getElementById('component-select');
            const propertyEditor = document.getElementById('property-editor');
            const propertiesForm = document.getElementById('properties-form');
            const saveJsonBtn = document.getElementById('save-json');
            const loadJsonInput = document.getElementById('load-json-input');
            const resizeCanvasBtn = document.getElementById('resize-canvas');
            const canvasWidthInput = document.getElementById('canvas-width');
            const canvasHeightInput = document.getElementById('canvas-height');
            const deleteComponentBtn = document.getElementById('delete-component');
            const contextMenu = document.getElementById('context-menu');
            const windowTitleInput = document.getElementById('window-title');
            
            // Preview
            const livePreviewBtn = document.getElementById('live-preview-btn');
            const previewModal = document.getElementById('preview-modal');
            const previewCanvas = document.getElementById('preview-canvas');
            const closePreviewBtn = document.getElementById('close-preview-btn');
            const fullscreenPreviewBtn = document.getElementById('fullscreen-preview-btn');

            let components = [];
            let selectedComponent = null;
            let componentIdCounter = 0;
            let contextComponentId = null;

            // Defaults (Consistent with NVLib v4)
            const getComponentDefaults = (type) => {
                const base = { textColor: '#1f2937', fontSize: 14, bold: false };
                const textBase = { ...base, text: type };
                
                switch (type) {
                    case 'Button': return { ...textBase, backgroundColor: '#ffffff', cornerRadius: 12 };
                    case 'Label': return { ...textBase, iconName: '' };
                    case 'TextBox': 
                    case 'TextArea': return { text: '', hintText: 'Type here...', hintColor: '#9ca3af', backgroundColor: '#ffffff', ...base };
                    case 'Checkbox': return { text: 'Checkbox', checked: false, checkedColor: '#6366f1', ...base };
                    case 'RadioGroup': return { label: 'Choose One', options: 'Option A\nOption B', checkedValue: 'Option A', checkedColor: '#6366f1', ...base };
                    case 'Dropdown': return { text: 'Select Option', options: 'Item 1\nItem 2', backgroundColor: '#ffffff', selectionColor: '#e0e7ff', ...base };
                    case 'Slider': return { min: 0, max: 100, value: 50, progressColor: '#6366f1', buttonColor: '#6366f1' };
                    case 'Panel': return { backgroundColor: '#f9fafb', cornerRadius: 16 };
                    case 'ProgressBar': return { value: 60, progressColor: '#6366f1', textColor: '#1f2937', textPosition: 'right' };
                    case 'Spinner': return { min: 0, max: 100, value: 0, backgroundColor: '#f3f4f6', ...base };
                    case 'CardView': return { ...textBase, text: '', backgroundColor: '#ffffff', cornerRadius: 16, elevation: 6 };
                    case 'ToggleButton': return { checked: false, onColor: '#6366f1', offColor: '#d1d5db' };
                    case 'Image': return { src: '', cornerRadius: 12, opacity: 1.0, fit: 'cover', backgroundColor: '#e5e7eb' };
                    default: return textBase;
                }
            };

            // Resize Canvas
            resizeCanvasBtn.addEventListener('click', () => {
                canvas.style.width = `${canvasWidthInput.value}px`;
                canvas.style.height = `${canvasHeightInput.value}px`;
            });

            // Add Component
            addComponentBtn.addEventListener('click', () => {
                const type = componentSelect.value;
                let id = `${type.toLowerCase()}_${componentIdCounter++}`;
                while (components.some(c => c.id === id)) {
                    id = `${type.toLowerCase()}_${componentIdCounter++}`;
                }
                
                const comp = {
                    id: id, type: type, x: 50, y: 50, width: 140, height: 45,
                    zIndex: components.length,
                    properties: getComponentDefaults(type)
                };

                if(type === 'Panel' || type === 'CardView') { comp.width = 240; comp.height = 160; }
                if(type === 'Image') { comp.width = 120; comp.height = 120; }
                if(type === 'RadioGroup') { comp.width = 160; comp.height = 100; }
                if(type === 'Slider') { comp.width = 200; comp.height = 30; }
                if(type === 'ToggleButton') { comp.width = 60; comp.height = 32; }
                if(type === 'Spinner') { comp.width = 120; comp.height = 40; }

                components.push(comp);
                renderAllComponents();
                selectComponent(id);
            });

            // Render
            function renderAllComponents() {
                components.sort((a, b) => a.zIndex - b.zIndex);
                canvas.innerHTML = '';
                components.forEach(comp => renderComponent(comp));
            }

            function renderComponent(comp) {
                const el = document.createElement('div');
                el.id = comp.id;
                el.className = 'component';
                if (selectedComponent && selectedComponent.id === comp.id) el.classList.add('selected');

                el.style.left = `${comp.x}px`;
                el.style.top = `${comp.y}px`;
                el.style.width = `${comp.width}px`;
                el.style.height = `${comp.height}px`;
                el.style.zIndex = comp.zIndex;
                el.style.borderRadius = (comp.properties.cornerRadius || 0) + 'px';

                const resizer = document.createElement('div');
                resizer.className = 'resizer';
                el.appendChild(resizer);

                const content = document.createElement('div');
                content.style.width = '100%';
                content.style.height = '100%';
                content.innerHTML = getComponentHTML(comp);
                el.appendChild(content);

                el.addEventListener('mousedown', (e) => startDrag(e, el));
                resizer.addEventListener('mousedown', (e) => startResize(e, el));
                el.addEventListener('click', (e) => { e.stopPropagation(); selectComponent(comp.id); });
                el.addEventListener('contextmenu', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    contextComponentId = comp.id;
                    contextMenu.style.left = `${e.clientX}px`;
                    contextMenu.style.top = `${e.clientY}px`;
                    contextMenu.classList.remove('hidden');
                    selectComponent(comp.id);
                });

                canvas.appendChild(el);
            }

            function getComponentHTML(comp) {
                const p = comp.properties;
                const baseTxt = `color:${p.textColor}; font-size:${p.fontSize}px; font-weight:${p.bold ? '700' : '500'};`;
                
                switch(comp.type) {
                    case 'Button':
                        return `<div class="component-render-wrapper" style="background:${p.backgroundColor}; border-radius:${p.cornerRadius}px; border:1px solid #e5e7eb; box-shadow:0 1px 2px rgba(0,0,0,0.05); ${baseTxt}">${p.text}</div>`;
                    case 'Label':
                        if(p.iconName) return `<div class="component-render-wrapper" style="${baseTxt}"><span class="material-symbols-rounded" style="font-size:${p.fontSize}px;">${p.iconName}</span></div>`;
                        return `<div class="component-render-wrapper" style="${baseTxt}">${p.text}</div>`;
                    case 'TextBox':
                        return `<div class="component-render-wrapper" style="background:${p.backgroundColor}; border:1px solid #d1d5db; border-radius:8px; padding:0 12px; justify-content:flex-start; ${baseTxt}">${p.text || `<span style="color:${p.hintColor}">${p.hintText}</span>`}</div>`;
                    case 'Checkbox':
                        return `<div class="component-render-wrapper" style="justify-content:flex-start; gap:10px;">
                            <div style="width:20px; height:20px; border:2px solid ${p.checked ? p.checkedColor : '#d1d5db'}; background:${p.checked ? p.checkedColor : 'white'}; border-radius:6px; display:flex; align-items:center; justify-content:center;">${p.checked ? '<span style="color:white; font-size:14px; font-weight:bold;">âœ“</span>' : ''}</div>
                            <span style="${baseTxt}">${p.text}</span>
                        </div>`;
                    case 'Panel':
                        return `<div class="component-render-wrapper" style="background:${p.backgroundColor}; border-radius:${p.cornerRadius}px; border:1px dashed #d1d5db;"></div>`;
                    case 'CardView':
                        return `<div class="component-render-wrapper" style="background:${p.backgroundColor}; border-radius:${p.cornerRadius}px; box-shadow:0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06); ${baseTxt}">${p.text || ''}</div>`;
                    case 'Image':
                        const src = p.src || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiM5Y2EzYWYiIHN0cm9rZS13aWR0aD0iMiI+PHJlY3QgeD0iMyIgeT0iMyIgd2lkdGg9IjE4IiBoZWlnaHQ9IjE4IiByeD0iMiIgcnk9IjIiPjwvcmVjdD48Y2lyY2xlIGN4PSI4LjUiIGN5PSI4LjUiIHI9IjEuNSI+PC9jaXJjbGU+PHBvbHlsaW5lIHBvaW50cz0iMjEgMTUgMTYgMTAgNSAyMSI+PC9wb2x5bGluZT48L3N2Zz4=';
                        return `<img src="${src}" style="width:100%; height:100%; object-fit:${p.fit}; border-radius:${p.cornerRadius}px; opacity:${p.opacity}; background:${p.backgroundColor};">`;
                    default:
                        return `<div class="component-render-wrapper" style="border:1px dashed #9ca3af; color:#9ca3af; border-radius:8px; font-size:12px;">${comp.type}</div>`;
                }
            }

            // Drag
            function startDrag(e, el) {
                if(e.target.className === 'resizer') return;
                const startX = e.clientX;
                const startY = e.clientY;
                const startLeft = el.offsetLeft;
                const startTop = el.offsetTop;
                
                const onMove = (mv) => {
                    let newLeft = startLeft + (mv.clientX - startX);
                    let newTop = startTop + (mv.clientY - startY);
                    
                    // Snap to 10px grid
                    newLeft = Math.round(newLeft / 10) * 10;
                    newTop = Math.round(newTop / 10) * 10;
                    
                    el.style.left = `${newLeft}px`;
                    el.style.top = `${newTop}px`;
                };

                const onUp = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    const c = components.find(x => x.id === el.id);
                    if(c) { c.x = el.offsetLeft; c.y = el.offsetTop; }
                };
                
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            }

            // Resize
            function startResize(e, el) {
                e.stopPropagation();
                const startX = e.clientX;
                const startY = e.clientY;
                const startW = el.offsetWidth;
                const startH = el.offsetHeight;

                const onMove = (mv) => {
                    let newW = startW + (mv.clientX - startX);
                    let newH = startH + (mv.clientY - startY);
                    if(newW < 20) newW = 20;
                    if(newH < 20) newH = 20;
                    
                    newW = Math.round(newW / 10) * 10;
                    newH = Math.round(newH / 10) * 10;

                    el.style.width = `${newW}px`;
                    el.style.height = `${newH}px`;
                };

                const onUp = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    const c = components.find(x => x.id === el.id);
                    if(c) { c.width = el.offsetWidth; c.height = el.offsetHeight; }
                };

                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            }

            // Selection & Properties
            function selectComponent(id) {
                document.querySelectorAll('.component').forEach(c => c.classList.remove('selected'));
                if (!id) {
                    selectedComponent = null;
                    propertyEditor.classList.add('hidden');
                    return;
                }
                
                const el = document.getElementById(id);
                if(el) el.classList.add('selected');
                
                selectedComponent = components.find(c => c.id === id);
                propertyEditor.classList.remove('hidden');
                renderProperties();
            }
            
            document.getElementById('close-props').addEventListener('click', () => selectComponent(null));

            function renderProperties() {
                propertiesForm.innerHTML = '';
                if(!selectedComponent) return;

                // Title
                const title = document.createElement('h3');
                title.className = "text-lg font-bold text-gray-800 mb-4 pb-2 border-b border-gray-100";
                title.textContent = selectedComponent.type;
                propertiesForm.appendChild(title);

                // ID
                createPropField('text', 'Unique ID', selectedComponent.id, (val) => {
                    if(components.some(c => c.id === val && c.id !== selectedComponent.id)) {
                        alert("ID must be unique");
                        return;
                    }
                    const oldId = selectedComponent.id;
                    selectedComponent.id = val;
                    document.getElementById(oldId).id = val;
                });

                const p = selectedComponent.properties;
                Object.keys(p).forEach(key => {
                    if(key === 'visible') return; 

                    let type = 'text';
                    if(typeof p[key] === 'number') type = 'number';
                    if(typeof p[key] === 'boolean') type = 'checkbox';
                    if(key.toLowerCase().includes('color')) type = 'color';
                    if(key === 'options' || (key === 'text' && selectedComponent.type === 'TextArea')) type = 'textarea';
                    if(key === 'src' && selectedComponent.type === 'Image') type = 'file';

                    createPropField(type, key, p[key], (val) => {
                        selectedComponent.properties[key] = val;
                        // For corner radius, update the container directly for smoother preview
                        if(key === 'cornerRadius') {
                             document.getElementById(selectedComponent.id).style.borderRadius = val + 'px';
                        }
                        const wrapper = document.getElementById(selectedComponent.id).querySelector('.component-render-wrapper') 
                                        || document.getElementById(selectedComponent.id).querySelector('img');
                        if(wrapper) {
                            renderComponent(selectedComponent); 
                            selectComponent(selectedComponent.id);
                        }
                    });
                });
            }

            function createPropField(type, label, value, callback) {
                const wrapper = document.createElement('div');
                wrapper.className = 'mb-4';
                
                const lbl = document.createElement('label');
                lbl.className = 'block text-xs font-bold text-gray-500 uppercase mb-1.5 tracking-wide';
                lbl.textContent = label.replace(/([A-Z])/g, ' $1').trim();
                
                let input;
                if(type === 'textarea') {
                    input = document.createElement('textarea');
                    input.rows = 3;
                    input.className = 'w-full p-2.5 text-sm bg-gray-50 border border-gray-200 rounded-lg focus:border-indigo-500 focus:bg-white outline-none transition';
                    input.value = value;
                    input.addEventListener('input', (e) => callback(e.target.value));
                    wrapper.appendChild(lbl);
                    wrapper.appendChild(input);
                } else if(type === 'checkbox') {
                    const row = document.createElement('div');
                    row.className = 'flex items-center gap-3 p-3 bg-gray-50 rounded-lg border border-gray-100';
                    input = document.createElement('input');
                    input.type = 'checkbox';
                    input.checked = value;
                    input.className = 'w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500';
                    input.addEventListener('change', (e) => callback(e.target.checked));
                    row.appendChild(input);
                    
                    const span = document.createElement('span');
                    span.className = 'text-sm font-medium text-gray-700';
                    span.textContent = label.replace(/([A-Z])/g, ' $1').trim();
                    row.appendChild(span);
                    wrapper.appendChild(row);
                } else if (type === 'file') {
                    wrapper.appendChild(lbl);
                    input = document.createElement('input');
                    input.type = 'file';
                    input.className = 'w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100';
                    input.addEventListener('change', (e) => {
                        const f = e.target.files[0];
                        if(f) {
                            const reader = new FileReader();
                            reader.onload = (re) => callback(re.target.result);
                            reader.readAsDataURL(f);
                        }
                    });
                    wrapper.appendChild(input);
                } else {
                    wrapper.appendChild(lbl);
                    input = document.createElement('input');
                    input.type = type;
                    input.value = value;
                    input.className = 'w-full p-2.5 text-sm bg-gray-50 border border-gray-200 rounded-lg focus:border-indigo-500 focus:bg-white outline-none transition';
                    if(type === 'color') input.className = 'w-full h-10 p-1 cursor-pointer bg-white border border-gray-200 rounded-lg';
                    input.addEventListener('input', (e) => callback(type === 'number' ? parseFloat(e.target.value) : e.target.value));
                    wrapper.appendChild(input);
                }
                
                propertiesForm.appendChild(wrapper);
            }

            // Deletion
            deleteComponentBtn.addEventListener('click', () => {
                if(selectedComponent) {
                    components = components.filter(c => c.id !== selectedComponent.id);
                    renderAllComponents();
                    selectComponent(null);
                }
            });

            // JSON Logic
            saveJsonBtn.addEventListener('click', () => {
                const layout = {
                    canvas: {
                        width: parseInt(canvasWidthInput.value),
                        height: parseInt(canvasHeightInput.value),
                        title: windowTitleInput.value
                    },
                    components: [...components].sort((a,b) => a.zIndex - b.zIndex)
                };
                
                const blob = new Blob([JSON.stringify(layout, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'layout.json';
                a.click();
            });

            loadJsonInput.addEventListener('change', (e) => {
                const f = e.target.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = (re) => {
                    try {
                        const json = JSON.parse(re.target.result);
                        if(json.canvas) {
                            canvasWidthInput.value = json.canvas.width;
                            canvasHeightInput.value = json.canvas.height;
                            windowTitleInput.value = json.canvas.title || "My App";
                            canvas.style.width = `${json.canvas.width}px`;
                            canvas.style.height = `${json.canvas.height}px`;
                        }
                        if(json.components) {
                            components = json.components.map((c, i) => ({
                                ...c,
                                zIndex: c.zIndex !== undefined ? c.zIndex : i
                            }));
                            componentIdCounter = components.length + 50; 
                            renderAllComponents();
                        }
                    } catch(err) {
                        alert("Invalid JSON");
                    }
                };
                r.readAsText(f);
                e.target.value = '';
            });

            // Context Menu Actions
            document.addEventListener('click', () => contextMenu.classList.add('hidden'));
            
            contextMenu.addEventListener('click', (e) => {
                const action = e.target.closest('a')?.dataset.action;
                if(!action || !contextComponentId) return;
                
                const comp = components.find(c => c.id === contextComponentId);
                const sorted = [...components].sort((a,b) => a.zIndex - b.zIndex);
                const idx = sorted.indexOf(comp);

                if(action === 'bring-to-front') {
                    comp.zIndex = components.length + 10;
                } else if(action === 'send-to-back') {
                    comp.zIndex = -1;
                } else if(action === 'bring-forward') {
                    if(idx < sorted.length - 1) {
                         const upper = sorted[idx+1];
                         const temp = upper.zIndex;
                         upper.zIndex = comp.zIndex;
                         comp.zIndex = temp; 
                    }
                } else if(action === 'send-backward') {
                    if(idx > 0) {
                        const lower = sorted[idx-1];
                        const temp = lower.zIndex;
                        lower.zIndex = comp.zIndex;
                        comp.zIndex = temp;
                    }
                } else if(action === 'duplicate') {
                    const clone = JSON.parse(JSON.stringify(comp));
                    clone.id = comp.id + '_copy_' + Math.floor(Math.random()*1000);
                    clone.x += 20; clone.y += 20;
                    clone.zIndex = components.length + 10;
                    components.push(clone);
                }

                components.sort((a,b) => a.zIndex - b.zIndex).forEach((c, i) => c.zIndex = i);
                renderAllComponents();
                contextMenu.classList.add('hidden');
            });

            // Preview
            livePreviewBtn.addEventListener('click', () => {
                previewCanvas.innerHTML = '';
                previewCanvas.style.width = canvas.style.width;
                previewCanvas.style.height = canvas.style.height;
                
                [...components].sort((a,b) => a.zIndex - b.zIndex).forEach(c => {
                    const el = document.createElement('div');
                    el.style.position = 'absolute';
                    el.style.left = `${c.x}px`;
                    el.style.top = `${c.y}px`;
                    el.style.width = `${c.width}px`;
                    el.style.height = `${c.height}px`;
                    el.style.borderRadius = (c.properties.cornerRadius || 0) + 'px';
                    el.innerHTML = getComponentHTML(c);
                    previewCanvas.appendChild(el);
                });
                
                previewModal.classList.remove('hidden');
            });
            
            closePreviewBtn.addEventListener('click', () => {
                previewModal.classList.add('hidden');
                if(document.fullscreenElement) document.exitFullscreen();
            });

            fullscreenPreviewBtn.addEventListener('click', () => {
                if(!document.fullscreenElement) previewCanvas.parentElement.requestFullscreen();
                else document.exitFullscreen();
            });

        });
    </script>
</body>
</html>
