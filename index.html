<!-- START OF FILE Paste January 18, 2026 - 12:00PM -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NVLib v4 GUI Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet" />
    <style>
        body { font-family: 'Inter', sans-serif; }
        .canvas {
            background-color: #f9fafb;
            border: 1px solid #d1d5db;
            position: relative;
            overflow: hidden;
            background-image:
                linear-gradient(to right, #e5e7eb 1px, transparent 1px),
                linear-gradient(to bottom, #e5e7eb 1px, transparent 1px);
            background-size: 20px 20px;
        }
        .component {
            position: absolute;
            cursor: move;
            border: 1px solid transparent; /* Visual aid for selection */
            user-select: none;
            font-size: 14px;
            box-sizing: border-box;
        }
        .component.selected {
            outline: 2px solid #4f46e5; /* NVLib v4 Primary Color */
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.4);
            z-index: 1000 !important; /* Bring selected temporarily to front for editing */
        }
        .resizer {
            width: 10px;
            height: 10px;
            background: #4f46e5;
            border: 1px solid white;
            position: absolute;
            right: -5px;
            bottom: -5px;
            cursor: se-resize;
            display: none;
        }
        .component.selected .resizer { display: block; }
        
        .component-render-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            box-sizing: border-box;
        }
        .id-error {
            background-color: #fee2e2 !important;
            border-color: #ef4444 !important;
        }
        .material-symbols-outlined {
          font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }
        /* Preview Modal Styles */
        .preview-component { position: absolute; box-sizing: border-box; }
        .preview-button:active { transform: scale(0.98); filter: brightness(0.95); }
        
        /* Context Menu */
        #context-menu { width: 160px; }
        .submenu-container:hover .submenu { display: block; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-white shadow-md p-4 flex justify-between items-center z-20">
        <div class="flex items-center gap-4">
            <h1 class="text-2xl font-bold text-indigo-700">NVLib v4 Builder</h1>
            <a href="docs.html" target="_blank" class="flex items-center gap-1 text-sm font-medium text-gray-600 hover:text-indigo-600 transition-colors">
                <span class="material-symbols-outlined text-lg">menu_book</span> Docs
            </a>
        </div>

        <div class="flex items-center space-x-3">
            <div class="flex items-center space-x-2 border-r pr-4 mr-2">
                <label for="window-title" class="text-xs font-bold uppercase text-gray-500">Title</label>
                <input type="text" id="window-title" value="My NVLib App" class="w-40 p-1.5 text-sm border border-gray-300 rounded focus:border-indigo-500 outline-none">
            </div>
            
            <div class="flex items-center space-x-2">
                <input type="number" id="canvas-width" value="800" class="w-16 p-1.5 text-sm border border-gray-300 rounded text-center">
                <span class="text-gray-400">x</span>
                <input type="number" id="canvas-height" value="600" class="w-16 p-1.5 text-sm border border-gray-300 rounded text-center">
                <button id="resize-canvas" class="p-1.5 bg-gray-200 hover:bg-gray-300 rounded text-gray-700">
                    <span class="material-symbols-outlined text-lg block">aspect_ratio</span>
                </button>
            </div>

            <div class="h-6 w-px bg-gray-300 mx-2"></div>

            <button id="live-preview-btn" class="flex items-center gap-1 px-3 py-1.5 bg-purple-600 text-white text-sm rounded hover:bg-purple-700 transition shadow">
                <span class="material-symbols-outlined text-sm">play_arrow</span> Preview
            </button>
            <button id="save-json" class="flex items-center gap-1 px-3 py-1.5 bg-indigo-600 text-white text-sm rounded hover:bg-indigo-700 transition shadow">
                <span class="material-symbols-outlined text-sm">save</span> Save JSON
            </button>
            <label for="load-json-input" class="flex items-center gap-1 px-3 py-1.5 bg-gray-700 text-white text-sm rounded hover:bg-gray-800 transition shadow cursor-pointer">
                <span class="material-symbols-outlined text-sm">upload</span> Load
            </label>
            <input type="file" id="load-json-input" class="hidden" accept=".json">
        </div>
    </header>

    <!-- Main Workspace -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Left Sidebar: Components -->
        <aside class="w-64 bg-white border-r border-gray-200 flex flex-col z-10 shadow-sm">
            <div class="p-4 border-b border-gray-100">
                <h2 class="text-sm font-bold uppercase text-gray-500 mb-3">Toolbox</h2>
                <select id="component-select" class="w-full p-2 mb-3 text-sm border border-gray-300 rounded bg-gray-50 focus:border-indigo-500 outline-none">
                    <option value="Button">Button</option>
                    <option value="Label">Label</option>
                    <option value="TextBox">TextBox</option>
                    <option value="TextArea">TextArea</option>
                    <option value="Checkbox">Checkbox</option>
                    <option value="RadioGroup">RadioGroup</option>
                    <option value="Dropdown">Dropdown</option>
                    <option value="Slider">Slider</option>
                    <option value="ProgressBar">ProgressBar</option>
                    <option value="Spinner">Spinner</option>
                    <option value="ToggleButton">ToggleButton</option>
                    <option disabled>--- Containers ---</option>
                    <option value="Panel">Panel (Background)</option>
                    <option value="CardView">CardView (Shadow)</option>
                    <option value="Image">Image</option>
                </select>
                <button id="add-component" class="w-full py-2 bg-indigo-100 text-indigo-700 font-semibold rounded hover:bg-indigo-200 transition">
                    + Add to Canvas
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-4">
                <div class="bg-blue-50 border border-blue-100 rounded p-3 text-xs text-blue-800 leading-relaxed">
                    <strong>NVLib v4 Workflow:</strong>
                    <ol class="list-decimal ml-4 mt-2 space-y-1">
                        <li>Design your screen here.</li>
                        <li>Save as <code class="bg-blue-100 px-1 rounded">screen1.json</code>.</li>
                        <li>In Python:
                            <pre class="mt-1 bg-white p-1 rounded border border-blue-100 overflow-x-auto">app.register_screen("s1", "screen1.json")</pre>
                        </li>
                    </ol>
                </div>
                <div class="mt-4 text-xs text-gray-400">
                    <p>Right-click components to manage layers (Bring to Front / Send to Back).</p>
                </div>
            </div>
        </aside>

        <!-- Center: Canvas -->
        <main class="flex-1 bg-gray-100 overflow-auto flex items-center justify-center p-8 relative" id="canvas-container">
            <div id="canvas" class="canvas shadow-xl bg-white transition-all duration-200" style="width: 800px; height: 600px;"></div>
        </main>

        <!-- Right Sidebar: Properties -->
        <aside id="property-editor" class="w-80 bg-white border-l border-gray-200 overflow-y-auto hidden z-10 shadow-sm flex flex-col">
            <div class="p-4 border-b border-gray-100 flex justify-between items-center">
                <h2 class="text-sm font-bold uppercase text-gray-500">Properties</h2>
                <button id="close-props" class="text-gray-400 hover:text-gray-600"><span class="material-symbols-outlined text-sm">close</span></button>
            </div>
            
            <div id="properties-form" class="p-4 space-y-4 flex-1">
                <!-- Dynamic Inputs go here -->
            </div>

            <div class="p-4 border-t border-gray-100 bg-gray-50">
                <button id="delete-component" class="w-full py-2 bg-red-100 text-red-600 font-semibold rounded hover:bg-red-200 transition flex items-center justify-center gap-2">
                    <span class="material-symbols-outlined text-sm">delete</span> Delete
                </button>
            </div>
        </aside>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="hidden fixed bg-white shadow-xl rounded-lg py-1 z-50 border border-gray-100 w-48 text-sm">
        <a href="#" data-action="duplicate" class="block px-4 py-2 text-gray-700 hover:bg-gray-50 flex items-center gap-2">
            <span class="material-symbols-outlined text-base text-gray-400">content_copy</span> Duplicate
        </a>
        <div class="border-t my-1"></div>
        <a href="#" data-action="bring-to-front" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">Bring to Front</a>
        <a href="#" data-action="send-to-back" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">Send to Back</a>
        <div class="border-t my-1"></div>
        <a href="#" data-action="bring-forward" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">Step Forward</a>
        <a href="#" data-action="send-backward" class="block px-4 py-2 text-gray-700 hover:bg-gray-50">Step Backward</a>
    </div>

    <!-- Preview Modal -->
    <div id="preview-modal" class="fixed inset-0 z-50 hidden bg-gray-900 bg-opacity-50 backdrop-blur-sm flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-2xl flex flex-col w-full h-full max-w-5xl max-h-[90vh] overflow-hidden">
            <div class="px-4 py-3 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-gray-700 flex items-center gap-2">
                    <span class="material-symbols-outlined text-purple-600">preview</span> Live Preview
                </h3>
                <div class="flex gap-2">
                    <button id="fullscreen-preview-btn" class="px-3 py-1 bg-white border border-gray-300 text-gray-700 rounded hover:bg-gray-50 text-xs font-medium uppercase">Fullscreen</button>
                    <button id="close-preview-btn" class="px-3 py-1 bg-red-500 text-white rounded hover:bg-red-600 text-xs font-medium uppercase">Close</button>
                </div>
            </div>
            <div class="flex-1 bg-gray-200 overflow-auto p-8 flex justify-center">
                <div id="preview-canvas" class="bg-white shadow-lg transition-all relative"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // -- Elements --
            const canvas = document.getElementById('canvas');
            const addComponentBtn = document.getElementById('add-component');
            const componentSelect = document.getElementById('component-select');
            const propertyEditor = document.getElementById('property-editor');
            const propertiesForm = document.getElementById('properties-form');
            const saveJsonBtn = document.getElementById('save-json');
            const loadJsonInput = document.getElementById('load-json-input');
            const resizeCanvasBtn = document.getElementById('resize-canvas');
            const canvasWidthInput = document.getElementById('canvas-width');
            const canvasHeightInput = document.getElementById('canvas-height');
            const deleteComponentBtn = document.getElementById('delete-component');
            const contextMenu = document.getElementById('context-menu');
            const windowTitleInput = document.getElementById('window-title');
            
            // Preview Elements
            const livePreviewBtn = document.getElementById('live-preview-btn');
            const previewModal = document.getElementById('preview-modal');
            const previewCanvas = document.getElementById('preview-canvas');
            const closePreviewBtn = document.getElementById('close-preview-btn');
            const fullscreenPreviewBtn = document.getElementById('fullscreen-preview-btn');

            // -- State --
            let components = [];
            let selectedComponent = null;
            let componentIdCounter = 0;
            let contextComponentId = null;

            // -- Defaults (Synced with AutoGUI.py v4) --
            const getComponentDefaults = (type) => {
                const base = { textColor: '#000000', fontSize: 14, bold: false };
                const textBase = { ...base, text: type };
                
                switch (type) {
                    case 'Button': return { ...textBase, backgroundColor: '#ffffff', cornerRadius: 4 };
                    case 'Label': return { ...textBase, iconName: '' };
                    case 'TextBox': 
                    case 'TextArea': return { text: '', hintText: 'Enter text...', hintColor: '#888888', backgroundColor: '#ffffff', ...base };
                    case 'Checkbox': return { text: 'Option', checked: false, checkedColor: '#4f46e5', ...base };
                    case 'RadioGroup': return { label: 'Group Label', options: 'Option 1\nOption 2', checkedValue: 'Option 1', checkedColor: '#4f46e5', ...base };
                    case 'Dropdown': return { text: 'Select...', options: 'Option 1\nOption 2', backgroundColor: '#ffffff', selectionColor: '#e0e7ff', ...base };
                    case 'Slider': return { min: 0, max: 100, value: 50, progressColor: '#4f46e5', buttonColor: '#4f46e5' };
                    case 'Panel': return { backgroundColor: '#f0f0f0', cornerRadius: 0 };
                    case 'ProgressBar': return { value: 50, progressColor: '#4f46e5', textColor: '#000000', textPosition: 'right' };
                    case 'Spinner': return { min: 0, max: 100, value: 0, backgroundColor: '#f0f0f0', ...base };
                    case 'CardView': return { ...textBase, text: '', backgroundColor: '#ffffff', cornerRadius: 8, elevation: 4 };
                    case 'ToggleButton': return { checked: false, onColor: '#4f46e5', offColor: '#d1d5db' };
                    case 'Image': return { src: '', cornerRadius: 0, opacity: 1.0, fit: 'cover', backgroundColor: '#e5e7eb' };
                    default: return textBase;
                }
            };

            // -- Resize Canvas --
            resizeCanvasBtn.addEventListener('click', () => {
                canvas.style.width = `${canvasWidthInput.value}px`;
                canvas.style.height = `${canvasHeightInput.value}px`;
            });

            // -- Add Component --
            addComponentBtn.addEventListener('click', () => {
                const type = componentSelect.value;
                let id = `${type.toLowerCase()}_${componentIdCounter++}`;
                // Ensure unique ID
                while (components.some(c => c.id === id)) {
                    id = `${type.toLowerCase()}_${componentIdCounter++}`;
                }
                
                const comp = {
                    id: id, type: type, x: 50, y: 50, width: 120, height: 40,
                    zIndex: components.length,
                    properties: getComponentDefaults(type)
                };

                // Adjust default sizes based on type
                if(type === 'Panel' || type === 'CardView') { comp.width = 200; comp.height = 150; }
                if(type === 'Image') { comp.width = 100; comp.height = 100; }
                if(type === 'RadioGroup') { comp.width = 150; comp.height = 100; }
                if(type === 'Slider') { comp.width = 200; comp.height = 30; }
                if(type === 'ToggleButton') { comp.width = 60; comp.height = 30; }
                if(type === 'Spinner') { comp.width = 120; comp.height = 40; }

                components.push(comp);
                renderAllComponents();
                selectComponent(id);
            });

            // -- Rendering --
            function renderAllComponents() {
                // Sort by zIndex for visual stacking
                components.sort((a, b) => a.zIndex - b.zIndex);
                canvas.innerHTML = '';
                components.forEach(comp => renderComponent(comp));
            }

            function renderComponent(comp) {
                const el = document.createElement('div');
                el.id = comp.id;
                el.className = 'component';
                if (selectedComponent && selectedComponent.id === comp.id) el.classList.add('selected');

                el.style.left = `${comp.x}px`;
                el.style.top = `${comp.y}px`;
                el.style.width = `${comp.width}px`;
                el.style.height = `${comp.height}px`;
                el.style.zIndex = comp.zIndex;

                // Add Drag/Resize Logic
                const resizer = document.createElement('div');
                resizer.className = 'resizer';
                el.appendChild(resizer);

                // Content
                const content = document.createElement('div');
                content.style.width = '100%';
                content.style.height = '100%';
                content.innerHTML = getComponentHTML(comp);
                el.appendChild(content);

                // Events
                el.addEventListener('mousedown', (e) => startDrag(e, el));
                resizer.addEventListener('mousedown', (e) => startResize(e, el));
                el.addEventListener('click', (e) => { e.stopPropagation(); selectComponent(comp.id); });
                el.addEventListener('contextmenu', (e) => {
                    e.preventDefault(); e.stopPropagation();
                    contextComponentId = comp.id;
                    contextMenu.style.left = `${e.clientX}px`;
                    contextMenu.style.top = `${e.clientY}px`;
                    contextMenu.classList.remove('hidden');
                    selectComponent(comp.id);
                });

                canvas.appendChild(el);
            }

            // HTML Generator for Editor View (Simplified approximation of KivyMD)
            function getComponentHTML(comp) {
                const p = comp.properties;
                const baseTxt = `color:${p.textColor}; font-size:${p.fontSize}px; font-weight:${p.bold ? '700' : '400'};`;
                
                switch(comp.type) {
                    case 'Button':
                        return `<div class="component-render-wrapper" style="background:${p.backgroundColor}; border-radius:${p.cornerRadius}px; border:1px solid #ddd; ${baseTxt}">${p.text}</div>`;
                    case 'Label':
                        if(p.iconName) return `<div class="component-render-wrapper" style="${baseTxt}"><span class="material-symbols-outlined" style="font-size:${p.fontSize}px;">${p.iconName}</span></div>`;
                        return `<div class="component-render-wrapper" style="${baseTxt}">${p.text}</div>`;
                    case 'TextBox':
                        return `<div class="component-render-wrapper" style="background:${p.backgroundColor}; border:1px solid #ccc; border-radius:4px; padding:0 8px; justify-content:flex-start; ${baseTxt}">${p.text || `<span style="color:${p.hintColor}">${p.hintText}</span>`}</div>`;
                    case 'Checkbox':
                        return `<div class="component-render-wrapper" style="justify-content:flex-start; gap:8px;">
                            <div style="width:18px; height:18px; border:2px solid ${p.checked ? p.checkedColor : '#999'}; background:${p.checked ? p.checkedColor : 'transparent'}; border-radius:2px;"></div>
                            <span style="${baseTxt}">${p.text}</span>
                        </div>`;
                    case 'Panel':
                        return `<div class="component-render-wrapper" style="background:${p.backgroundColor}; border-radius:${p.cornerRadius}px; border:1px dashed #ccc;"></div>`;
                    case 'CardView':
                        return `<div class="component-render-wrapper" style="background:${p.backgroundColor}; border-radius:${p.cornerRadius}px; box-shadow:0 2px 5px rgba(0,0,0,0.2); ${baseTxt}">${p.text || ''}</div>`;
                    case 'Image':
                        const src = p.src || 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJub25lIiBzdHJva2U9IiNjY2MiIHN0cm9rZS13aWR0aD0iMiI+PHJlY3QgeD0iMyIgeT0iMyIgd2lkdGg9IjE4IiBoZWlnaHQ9IjE4IiByeD0iMiIgcnk9IjIiPjwvcmVjdD48Y2lyY2xlIGN4PSI4LjUiIGN5PSI4LjUiIHI9IjEuNSI+PC9jaXJjbGU+PHBvbHlsaW5lIHBvaW50cz0iMjEgMTUgMTYgMTAgNSAyMSI+PC9wb2x5bGluZT48L3N2Zz4=';
                        return `<img src="${src}" style="width:100%; height:100%; object-fit:${p.fit}; border-radius:${p.cornerRadius}px; opacity:${p.opacity}; background:${p.backgroundColor};">`;
                    default:
                        return `<div class="component-render-wrapper" style="border:1px dashed #999; ${baseTxt}">${comp.type}</div>`;
                }
            }

            // -- Dragging Logic --
            function startDrag(e, el) {
                if(e.target.className === 'resizer') return;
                const startX = e.clientX;
                const startY = e.clientY;
                const startLeft = el.offsetLeft;
                const startTop = el.offsetTop;
                
                const onMove = (mv) => {
                    let newLeft = startLeft + (mv.clientX - startX);
                    let newTop = startTop + (mv.clientY - startY);
                    
                    // Simple snapping (10px grid)
                    newLeft = Math.round(newLeft / 10) * 10;
                    newTop = Math.round(newTop / 10) * 10;
                    
                    el.style.left = `${newLeft}px`;
                    el.style.top = `${newTop}px`;
                };

                const onUp = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    // Update data
                    const c = components.find(x => x.id === el.id);
                    if(c) { c.x = el.offsetLeft; c.y = el.offsetTop; }
                };
                
                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            }

            // -- Resizing Logic --
            function startResize(e, el) {
                e.stopPropagation();
                const startX = e.clientX;
                const startY = e.clientY;
                const startW = el.offsetWidth;
                const startH = el.offsetHeight;

                const onMove = (mv) => {
                    let newW = startW + (mv.clientX - startX);
                    let newH = startH + (mv.clientY - startY);
                    if(newW < 20) newW = 20;
                    if(newH < 20) newH = 20;
                    
                    // Snap
                    newW = Math.round(newW / 10) * 10;
                    newH = Math.round(newH / 10) * 10;

                    el.style.width = `${newW}px`;
                    el.style.height = `${newH}px`;
                };

                const onUp = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                    const c = components.find(x => x.id === el.id);
                    if(c) { c.width = el.offsetWidth; c.height = el.offsetHeight; }
                };

                document.addEventListener('mousemove', onMove);
                document.addEventListener('mouseup', onUp);
            }

            // -- Property Editor --
            function selectComponent(id) {
                document.querySelectorAll('.component').forEach(c => c.classList.remove('selected'));
                if (!id) {
                    selectedComponent = null;
                    propertyEditor.classList.add('hidden');
                    return;
                }
                
                const el = document.getElementById(id);
                if(el) el.classList.add('selected');
                
                selectedComponent = components.find(c => c.id === id);
                propertyEditor.classList.remove('hidden');
                renderProperties();
            }
            
            document.getElementById('close-props').addEventListener('click', () => selectComponent(null));

            function renderProperties() {
                propertiesForm.innerHTML = '';
                if(!selectedComponent) return;

                // ID Field
                createPropField('text', 'Component ID', selectedComponent.id, (val) => {
                    // Unique check
                    if(components.some(c => c.id === val && c.id !== selectedComponent.id)) {
                        alert("ID must be unique");
                        return;
                    }
                    const oldId = selectedComponent.id;
                    selectedComponent.id = val;
                    document.getElementById(oldId).id = val;
                });

                const p = selectedComponent.properties;
                Object.keys(p).forEach(key => {
                    // Skip internal style keys not meant for GUI editing if needed
                    if(key === 'visible') return; 

                    let type = 'text';
                    if(typeof p[key] === 'number') type = 'number';
                    if(typeof p[key] === 'boolean') type = 'checkbox';
                    if(key.toLowerCase().includes('color')) type = 'color';
                    if(key === 'options' || key === 'text' && selectedComponent.type === 'TextArea') type = 'textarea';
                    if(key === 'src' && selectedComponent.type === 'Image') type = 'file';

                    createPropField(type, key, p[key], (val) => {
                        selectedComponent.properties[key] = val;
                        // Re-render only the HTML content, not the whole component div to keep selection
                        const wrapper = document.getElementById(selectedComponent.id).querySelector('div'); 
                        if(wrapper) {
                            // Quick refresh approach
                            renderComponent(selectedComponent); // Full re-render needed for some props
                            selectComponent(selectedComponent.id); // Re-select
                        }
                    });
                });
            }

            function createPropField(type, label, value, callback) {
                const wrapper = document.createElement('div');
                wrapper.className = 'mb-3';
                
                const lbl = document.createElement('label');
                lbl.className = 'block text-xs font-bold text-gray-500 uppercase mb-1';
                lbl.textContent = label.replace(/([A-Z])/g, ' $1').trim();
                
                let input;
                if(type === 'textarea') {
                    input = document.createElement('textarea');
                    input.rows = 3;
                    input.className = 'w-full p-2 text-sm border border-gray-300 rounded focus:border-indigo-500 outline-none';
                    input.value = value;
                    input.addEventListener('input', (e) => callback(e.target.value));
                    wrapper.appendChild(lbl);
                    wrapper.appendChild(input);
                } else if(type === 'checkbox') {
                    const row = document.createElement('div');
                    row.className = 'flex items-center gap-2';
                    input = document.createElement('input');
                    input.type = 'checkbox';
                    input.checked = value;
                    input.addEventListener('change', (e) => callback(e.target.checked));
                    row.appendChild(input);
                    row.appendChild(lbl);
                    wrapper.appendChild(row);
                } else if (type === 'file') {
                    wrapper.appendChild(lbl);
                    input = document.createElement('input');
                    input.type = 'file';
                    input.className = 'w-full text-xs';
                    input.addEventListener('change', (e) => {
                        const f = e.target.files[0];
                        if(f) {
                            const reader = new FileReader();
                            reader.onload = (re) => callback(re.target.result);
                            reader.readAsDataURL(f);
                        }
                    });
                    wrapper.appendChild(input);
                } else {
                    wrapper.appendChild(lbl);
                    input = document.createElement('input');
                    input.type = type;
                    input.value = value;
                    input.className = 'w-full p-2 text-sm border border-gray-300 rounded focus:border-indigo-500 outline-none';
                    if(type === 'color') input.className = 'w-full h-8 cursor-pointer';
                    input.addEventListener('input', (e) => callback(type === 'number' ? parseFloat(e.target.value) : e.target.value));
                    wrapper.appendChild(input);
                }
                
                propertiesForm.appendChild(wrapper);
            }

            // -- Deletion --
            deleteComponentBtn.addEventListener('click', () => {
                if(selectedComponent) {
                    components = components.filter(c => c.id !== selectedComponent.id);
                    renderAllComponents();
                    selectComponent(null);
                }
            });

            // -- JSON I/O --
            saveJsonBtn.addEventListener('click', () => {
                const layout = {
                    canvas: {
                        width: parseInt(canvasWidthInput.value),
                        height: parseInt(canvasHeightInput.value),
                        title: windowTitleInput.value
                    },
                    // Kivy draws in list order. Ensure lower zIndex comes first.
                    components: [...components].sort((a,b) => a.zIndex - b.zIndex)
                };
                
                const blob = new Blob([JSON.stringify(layout, null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'layout.json';
                a.click();
            });

            loadJsonInput.addEventListener('change', (e) => {
                const f = e.target.files[0];
                if(!f) return;
                const r = new FileReader();
                r.onload = (re) => {
                    try {
                        const json = JSON.parse(re.target.result);
                        if(json.canvas) {
                            canvasWidthInput.value = json.canvas.width;
                            canvasHeightInput.value = json.canvas.height;
                            windowTitleInput.value = json.canvas.title || "My App";
                            canvas.style.width = `${json.canvas.width}px`;
                            canvas.style.height = `${json.canvas.height}px`;
                        }
                        if(json.components) {
                            components = json.components.map((c, i) => ({
                                ...c,
                                zIndex: c.zIndex !== undefined ? c.zIndex : i // preserve or assign order
                            }));
                            // Reset counter to avoid ID clashes
                            componentIdCounter = components.length + 10; 
                            renderAllComponents();
                        }
                    } catch(err) {
                        alert("Invalid JSON");
                    }
                };
                r.readAsText(f);
                e.target.value = '';
            });

            // -- Context Menu Actions --
            document.addEventListener('click', () => contextMenu.classList.add('hidden'));
            
            contextMenu.addEventListener('click', (e) => {
                const action = e.target.closest('a')?.dataset.action;
                if(!action || !contextComponentId) return;
                
                const comp = components.find(c => c.id === contextComponentId);
                const sorted = [...components].sort((a,b) => a.zIndex - b.zIndex);
                const idx = sorted.indexOf(comp);

                if(action === 'bring-to-front') {
                    comp.zIndex = components.length + 1; // pushing higher
                } else if(action === 'send-to-back') {
                    comp.zIndex = -1; // pushing lower
                } else if(action === 'bring-forward') {
                    if(idx < sorted.length - 1) {
                         const upper = sorted[idx+1];
                         const temp = upper.zIndex;
                         upper.zIndex = comp.zIndex;
                         comp.zIndex = temp; 
                    }
                } else if(action === 'send-backward') {
                    if(idx > 0) {
                        const lower = sorted[idx-1];
                        const temp = lower.zIndex;
                        lower.zIndex = comp.zIndex;
                        comp.zIndex = temp;
                    }
                } else if(action === 'duplicate') {
                    const clone = JSON.parse(JSON.stringify(comp));
                    clone.id = comp.id + '_copy_' + Math.floor(Math.random()*1000);
                    clone.x += 20; clone.y += 20;
                    clone.zIndex = components.length + 10;
                    components.push(clone);
                }

                // Normalizing z-indexes to 0..N
                components.sort((a,b) => a.zIndex - b.zIndex).forEach((c, i) => c.zIndex = i);
                
                renderAllComponents();
                contextMenu.classList.add('hidden');
            });

            // -- Live Preview Logic (Simplified for brevity) --
            // Uses the same generation logic as renderComponent but static
            livePreviewBtn.addEventListener('click', () => {
                previewCanvas.innerHTML = '';
                previewCanvas.style.width = canvas.style.width;
                previewCanvas.style.height = canvas.style.height;
                
                // Sort by Z to ensure visual accuracy
                [...components].sort((a,b) => a.zIndex - b.zIndex).forEach(c => {
                    const el = document.createElement('div');
                    el.style.position = 'absolute';
                    el.style.left = `${c.x}px`;
                    el.style.top = `${c.y}px`;
                    el.style.width = `${c.width}px`;
                    el.style.height = `${c.height}px`;
                    el.innerHTML = getComponentHTML(c);
                    previewCanvas.appendChild(el);
                });
                
                previewModal.classList.remove('hidden');
            });
            
            closePreviewBtn.addEventListener('click', () => {
                previewModal.classList.add('hidden');
                if(document.fullscreenElement) document.exitFullscreen();
            });

            fullscreenPreviewBtn.addEventListener('click', () => {
                if(!document.fullscreenElement) previewCanvas.parentElement.requestFullscreen();
                else document.exitFullscreen();
            });

        });
    </script>
</body>
</html>
